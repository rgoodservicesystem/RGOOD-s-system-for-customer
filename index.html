<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Company Portal ‚Äî Smart Entry</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg1:#06b6d4; --bg2:#10b981; --ink:#0f172a; --mut:#64748b;
      --card:#ffffff; --radius:20px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:"Prompt",sans-serif; color:var(--ink);
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      min-height:100vh; display:flex; align-items:center; justify-content:center;
    }
    .container{
      width:100%; max-width:460px; background:var(--card); border-radius:var(--radius);
      padding:36px 28px; box-shadow:0 10px 40px rgba(0,0,0,.12); text-align:center;
    }
    h1{margin:0 0 8px; font-size:28px}
    p{margin:0 0 22px; color:var(--mut)}
    .btn{
      display:block; width:100%; padding:14px; margin:10px 0; border:none; border-radius:12px;
      font-weight:700; font-size:16px; color:#fff; cursor:pointer; text-decoration:none;
      background:linear-gradient(135deg,#0ea5e9,#10b981); transition:.2s;
    }
    .btn:hover{transform:translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,.15)}
    .btn.admin{background:linear-gradient(135deg,#8b5cf6,#ec4899)}
    .btn.admin:hover{box-shadow:0 4px 12px rgba(0,0,0,.2)}
    footer{margin-top:18px; font-size:12px; color:#94a3b8}
    .hide{display:none}
    .spinner{display:inline-block; width:18px; height:18px; border:3px solid #e5e7eb; border-top-color:#0ea5e9; border-radius:50%; animation:spin 1s linear infinite; vertical-align:-3px; margin-right:8px}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="container">
    <div id="loadingBox">
      <h1>üè¢ Company Portal</h1>
      <p><span class="spinner"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‚Ä¶</p>
      <p id="hint" class="hide" style="margin-top:8px;">‡∏ñ‡πâ‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á‡∏ô‡∏≤‡∏ô ‡∏•‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
    </div>

    <div id="choiceBox" class="hide">
      <h1>üè¢ Company Portal</h1>
      <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</p>
      <a href="customer.html" class="btn">üîì ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Customer)</a>
      <a href="admin_login.html" class="btn admin">üîê ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏• (Admin)</a>
      <footer>¬© 2025 Company Portal ‚Äî Powered by Supabase</footer>
    </div>
  </div>

  <script>
    // ------------ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase (‡πÉ‡∏ä‡πâ anon key) ------------
    const SUPABASE_URL = "https://phwigdhupzunbkywgxiq.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBod2lnZGh1cHp1bmJreXdneGlxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMTk2NjgsImV4cCI6MjA3NTU5NTY2OH0.5mWxBvX_VTZIpUOJiOvNAj-Vh1XEH4SNvbpk3YGuOEA"; // <- ‡πÉ‡∏™‡πà anon key ‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const loadingBox = document.getElementById('loadingBox');
    const choiceBox  = document.getElementById('choiceBox');
    const hint       = document.getElementById('hint');

    function showChoice(){
      loadingBox.classList.add('hide');
      choiceBox.classList.remove('hide');
    }

    // fallback safety: ‡∏ñ‡πâ‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡πÉ‡∏´‡πâ‡∏Ç‡∏∂‡πâ‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    const fallbackTimer = setTimeout(()=>{ hint.classList.remove('hide'); showChoice(); }, 4000);

    async function smartRoute(){
      // ‡∏ñ‡πâ‡∏≤‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢ query (?force=choice=1) ‡∏Å‡πá‡πÑ‡∏°‡πà redirect ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      const params = new URLSearchParams(location.search);
      if (params.get('force') === 'choice' || params.get('force') === 'choice=1'){
        clearTimeout(fallbackTimer);
        showChoice(); 
        return;
      }

      const { data: { user } } = await sb.auth.getUser();
      if(!user){
        clearTimeout(fallbackTimer);
        showChoice();
        return;
      }

      // ‡∏°‡∏µ session ‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏î‡∏∂‡∏á‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏à‡∏≤‡∏Å company_members
      const { data, error } = await sb
        .from('company_members')
        .select('role')
        .eq('user_id', user.id);

      clearTimeout(fallbackTimer);

      if(error){
        // ‡∏î‡∏∂‡∏á role ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚Üí ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏á
        showChoice();
        return;
      }

      if(!data || data.length === 0){
        // ‡πÑ‡∏°‡πà‡∏°‡∏µ mapping ‚Üí ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏á
        showChoice();
        return;
      }

      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏ñ‡∏ß ‡πÉ‡∏´‡πâ admin ‡∏ä‡∏ô‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
      const roles = data.map(r => (r.role || '').toLowerCase());
      if (roles.includes('admin')) {
        window.location.href = 'admin.html';
        return;
      }
      if (roles.includes('staff')) {
        // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏´‡∏ô‡πâ‡∏≤ staff ‡πÅ‡∏¢‡∏Å ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πà‡∏ô 'staff.html'
        // ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤ admin.html ‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô customer.html ‡∏Å‡πá‡πÑ‡∏î‡πâ
        window.location.href = 'admin.html';
        return;
      }
      // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‚Üí ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
      window.location.href = 'customer.html';
    }

    document.addEventListener('DOMContentLoaded', smartRoute);

    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ auth ‡∏Å‡∏•‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤ ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á route ‡πÉ‡∏´‡∏°‡πà
    sb.auth.onAuthStateChange((_event, _session) => {
      smartRoute();
    });
  </script>
</body>
  
</html>
