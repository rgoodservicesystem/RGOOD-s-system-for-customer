<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Customer Portal ‚Äî ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#f6fbff; --ink:#0f172a; --muted:#64748b; --card:#ffffff; --border:#e6eef5;
    --accent:#0ea5a5; --accent-2:#60a5fa;
    --ok:#0f766e;   --ok-bg:#ecfdf5;
    --warn:#92400e; --warn-bg:#fff7ed;
    --radius:14px;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:"Prompt",ui-sans-serif,system-ui; color:var(--ink); background:
    radial-gradient(1200px 600px at 10% -10%, #e6f7ff 0%, transparent 60%),
    radial-gradient(900px 500px at 110% 0%, #e8fff6 0%, transparent 60%),
    var(--bg);}
  header{padding:20px 16px; background:linear-gradient(180deg,#f0fbff,#eaf7ff); border-bottom:1px solid var(--border);}
  .brand{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:12px;font-weight:700;font-size:20px}
  .logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));}
  .container{max-width:1100px;margin:20px auto; padding:0 16px 28px;}
  .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:0 4px 20px rgba(10,30,60,.06); padding:18px; margin-bottom:16px;}
  label{display:block; margin:6px 0 8px; color:var(--muted); font-size:14px;}
  select, input, button{
    padding:11px 12px; font-size:15px; border:1px solid var(--border); border-radius:10px; outline:none; background:white;
  }
  .btn{cursor:pointer}
  .btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:white; border:none}
  table{width:100%; border-collapse:collapse; background:white; border-radius:12px; overflow:hidden}
  th,td{padding:10px 12px; border-bottom:1px solid var(--border); text-align:left; vertical-align:top}
  th{background:linear-gradient(180deg,#f7fbff,#f2f8ff); color:#0b3a4f; font-weight:600;}
  .hint{color:var(--muted); font-size:13px}
  .check-ok{ color:#065f46; background:#ecfdf5; border:1px solid #a7f3d0; padding:4px 10px; border-radius:10px; display:inline-block; font-size:12px; font-weight:600}
  .check-warn{ color:#92400e; background:#fff7ed; border:1px solid #fde68a; padding:4px 10px; border-radius:10px; display:inline-block; font-size:12px; font-weight:600}
</style>
</head>

<body>
<header>
  <div class="brand">
    <div class="logo"></div>
    <div>Customer Portal ‚Äî ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</div>
  </div>
</header>

<div class="container">
  <div class="card">
    <label><strong>üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô</strong></label>
    <div class="row" style="display:flex;gap:10px;flex-wrap:wrap;">
      <input id="custCodeInput" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô RG-1234" style="flex:1;min-width:260px">
      <button id="searchBtn" class="btn btn-primary">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
    </div>
    <div id="msg" class="hint" style="margin-top:8px"></div>
  </div>

  <div class="card" style="overflow:auto;">
    <table id="dataTable">
      <thead>
        <tr>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç/‡∏™‡∏π‡∏ï‡∏£</th>
          <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th>
          <th>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô</th>
          <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
          <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          <th>‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Å</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="7" style="color:var(--muted)">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
const SUPABASE_URL = "https://phwigdhupzunbkywgxiq.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBod2lnZGh1cHp1bmJreXdneGlxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwMTk2NjgsImV4cCI6MjA3NTU5NTY2OH0.5mWxBvX_VTZIpUOJiOvNAj-Vh1XEH4SNvbpk3YGuOEA";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const $ = id => document.getElementById(id);
const STAGES = [
  ['received','‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß'],
  ['doc_check','‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô'],
  ['submitted','‡∏¢‡∏∑‡πà‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏±‡∏ê'],
  ['pending_agency','‡∏£‡∏≠‡∏ú‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏±‡∏ê'],
  ['approved','‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß'],
  ['rejected','‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç']
];
const stageLabel = v => (STAGES.find(s=>s[0]===v)?.[1] || '-');

/* ===== ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡∏ö ‡∏û.‡∏®. ===== */
function fmtDateTH(d){
  if(!d) return '-';
  const t = new Date(d);
  if(isNaN(t)) return '-';
  const year = t.getFullYear() + 543;
  const monthNames = [
    "‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå","‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°","‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô","‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°","‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô",
    "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°","‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô","‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°","‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô","‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"
  ];
  return `${t.getDate()} ${monthNames[t.getMonth()]} ${year}`;
}

/* ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Å‡∏ß‡πà‡∏≤‡∏Ç‡∏≤‡∏î‡∏≠‡∏∞‡πÑ‡∏£ */
function buildChecklist(r){
  const missing=[];
  if(!r.registration_no) missing.push('‡∏Ç‡∏≤‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô');
  if(!r.license_no) missing.push('‡∏Ç‡∏≤‡∏î‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï');
  if(!r.expiry_date) missing.push('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô');
  if(!r.stage) missing.push('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô');

  if(missing.length===0) return `<span class="check-ok">‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‚úì</span>`;
  return `<span class="check-warn">${missing.join(' ‚Ä¢ ')}</span>`;
}

$('searchBtn').addEventListener('click', loadData);
$('custCodeInput').addEventListener('keydown', e => { if(e.key==='Enter') loadData(); });

async function loadData(){
  const code = $('custCodeInput').value.trim();
  if(!code) return $('msg').textContent = '‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤';

  $('msg').textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
  $('tbody').innerHTML = `<tr><td colspan="7" style="color:var(--muted)">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>`;

  try{
    // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏à‡∏≤‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
    const { data: comp, error: err1 } = await sb.from('companies')
      .select('code')
      .ilike('customer_code', code)
      .maybeSingle();
    if(err1) throw err1;
    if(!comp){
      $('msg').textContent = '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ';
      $('tbody').innerHTML = `<tr><td colspan="7" style="color:var(--muted)">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</td></tr>`;
      return;
    }

    const company = comp.code;

    const { data, error } = await sb.from('product_registrations')
      .select('*')
      .eq('company_code', company);
    if(error) throw error;

    if(!data || data.length===0){
      $('msg').textContent = `‚ÑπÔ∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ${company}`;
      $('tbody').innerHTML = `<tr><td colspan="7" style="color:var(--muted)">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</td></tr>`;
      return;
    }

    $('msg').textContent = `‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ${company}`;
    renderTable(data);
  }catch(err){
    $('msg').textContent = '‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (err?.message||err);
  }
}

/* ===== ‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á ===== */
function renderTable(rows){
  const tb = $('tbody');
  tb.innerHTML = rows.map(r=>`
    <tr>
      <td>${r.brand_name||'-'}</td>
      <td>${r.common_label||'-'}</td>
      <td>${fmtDateTH(r.expiry_date)}</td>
      <td>${stageLabel(r.stage)}</td>
      <td>${r.note||'-'}</td>
      <td>${r.custom_status||'-'}</td>
      <td>${buildChecklist(r)}</td>
    </tr>
  `).join('');
}
</script>
</body>
</html>
