<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin — Tracking & Diary</title>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{ --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#9ca3af; --border:#1f2937; --accent:#22d3ee; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; }
  *{box-sizing:border-box}
  body{margin:0; background:linear-gradient(180deg,#0b1224,#0f172a); color:var(--ink); font-family:'Prompt',system-ui;}
  .wrap{max-width:1200px; margin:24px auto; padding:16px}
  .grid{display:grid; grid-template-columns:320px 1fr; gap:16px}
  .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px}
  .row{display:flex; gap:8px; align-items:center; margin:8px 0; flex-wrap:wrap}
  input,select,textarea,button{border-radius:10px; border:1px solid var(--border); background:#0b1224; color:var(--ink); padding:10px 12px}
  button{background:var(--accent); color:#031b1d; font-weight:700; border:none; cursor:pointer}
  .list{display:flex; flex-direction:column; gap:8px; max-height:65vh; overflow:auto}
  .item{padding:12px; border:1px solid var(--border); border-radius:10px; background:#0e162c; cursor:pointer}
  .item.active{outline:2px solid var(--accent)}
  .tags{display:flex; gap:6px; flex-wrap:wrap}
  .pill{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; background:#072027; border:1px solid #10343a; font-size:12px}
  .h{font-weight:700; margin:6px 0 10px}
  .muted{color:var(--muted); font-size:12px}
  .log{white-space:pre-wrap; background:#071223; padding:8px; border-radius:8px; border:1px dashed #20314a; font-size:12px}
  /* modal */
  #pinModal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:9999}
</style>
</head>
<body>

<!-- ชั้นที่ 1: การ์ดล็อกอินทีมงาน -->
<div class="card" id="authCard" style="max-width:1200px; margin:16px auto 0">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
    <div><strong>เข้าสู่ระบบทีมงาน</strong> <span class="muted">อนุญาตเฉพาะ Admin/Staff</span></div>
    <div id="authArea" class="row">
      <input id="email" placeholder="email@company.com">
      <input id="password" type="password" placeholder="รหัสผ่าน">
      <button id="btnSignIn">เข้าสู่ระบบ</button>
      <button id="btnSignOut" style="display:none">ออกจากระบบ</button>
    </div>
  </div>
  <div class="muted" id="authMsg"></div>
</div>

<!-- ชั้นที่ 2: Modal Admin PIN -->
<div id="pinModal">
  <div class="card" style="width:min(420px,90vw)">
    <div class="row"><strong>ใส่รหัสผ่านหน้าแอดมิน (Admin PIN)</strong></div>
    <div class="row">
      <input id="adminPin" type="password" placeholder="PIN 6 หลัก">
      <button id="btnVerifyPin">ยืนยัน</button>
    </div>
    <div class="muted">* เพื่อความปลอดภัย จะถาม PIN หนึ่งครั้งต่อ session ของเบราว์เซอร์</div>
    <div class="muted" id="pinMsg"></div>
    <div class="row" style="margin-top:8px">
      <button id="btnSetPin" title="เฉพาะผู้ใช้ role admin">ตั้ง/เปลี่ยน PIN (เฉพาะ Admin)</button>
    </div>
  </div>
</div>

<!-- เนื้อหาแอดมินหลัก -->
<div id="mainWrap" style="display:none">
<div class="wrap">
  <h2>Admin — ระบบติดตามงานขึ้นทะเบียน (Tracking + Diary)</h2>
  <div class="grid">
    <div class="card">
      <div class="h">บริษัท & โปรเจ็กต์</div>
      <div class="row">
        <input id="search" placeholder="ค้นหาบริษัท/โปรเจ็กต์...">
        <button id="btnRefresh">รีเฟรช</button>
      </div>
      <div class="row">
        <input id="companyName" placeholder="ชื่อบริษัทใหม่">
        <input id="companyCode" placeholder="รหัส (เช่น RGD001)" style="width:140px">
        <button id="btnAddCompany">+ บริษัท</button>
      </div>
      <div class="row">
        <input id="projTitle" placeholder="หัวข้อโปรเจ็กต์ใหม่">
        <select id="projStatus">
          <option value="waiting_docs">รอเอกสาร</option>
          <option value="precheck">ตรวจเอกสารเบื้องต้น</option>
          <option value="submitted">ยื่นหน่วยงานแล้ว</option>
          <option value="pending_result">รอผล</option>
          <option value="done">เสร็จสิ้น</option>
          <option value="rejected">ถูกตีกลับ</option>
        </select>
        <input id="projDue" type="date">
        <button id="btnAddProject">+ โปรเจ็กต์</button>
      </div>

      <div class="list" id="list"></div>
    </div>

    <div class="card">
      <div class="h">รายละเอียดโปรเจ็กต์</div>
      <div class="tags">
        <span class="pill">สถานะ: <strong id="pStatus">-</strong></span>
        <span class="pill">กำหนดส่ง: <strong id="pDue">-</strong></span>
        <span class="pill">บริษัท: <strong id="pCompany">-</strong></span>
      </div>

      <div class="row">
        <select id="updStatus">
          <option value="waiting_docs">รอเอกสาร</option>
          <option value="precheck">ตรวจเอกสารเบื้องต้น</option>
          <option value="submitted">ยื่นหน่วยงานแล้ว</option>
          <option value="pending_result">รอผล</option>
          <option value="done">เสร็จสิ้น</option>
          <option value="rejected">ถูกตีกลับ</option>
        </select>
        <button id="btnUpdateStatus">เปลี่ยนสถานะ</button>
      </div>

      <div class="h">ไทม์ไลน์</div>
      <div class="row"><input id="tlStep" placeholder="ข้อความขั้นตอน เช่น “ยื่น อย. เลขรับ 012/68”" style="flex:1"></div>
      <div class="row"><textarea id="tlNote" rows="3" placeholder="รายละเอียดเพิ่มเติม (ถ้ามี)" style="flex:1"></textarea></div>
      <div class="row"><button id="btnAddTimeline">+ เพิ่มไทม์ไลน์</button></div>
      <div id="timeline"></div>

      <div class="h" style="margin-top:16px">ไดอารี่/ท้อก (ลูกค้าเห็น แต่โพสต์ไม่ได้)</div>
      <div class="row"><textarea id="msgBody" rows="3" placeholder="แจ้งลูกค้า เช่น ‘ได้รับเอกสารครบแล้ว กำลังตรวจ’" style="flex:1"></textarea></div>
      <div class="row"><button id="btnAddMsg">+ โพสต์ข้อความ</button></div>
      <div id="messages"></div>

      <div class="h" style="margin-top:16px">เอกสาร</div>
      <div class="row">
        <input type="file" id="docFile">
        <input id="docLabel" placeholder="ป้ายกำกับไฟล์ เช่น ‘บัตร ปชช.กรรมการ’">
        <button id="btnUpload">อัปโหลด</button>
      </div>
      <div id="docs"></div>

      <div class="h" style="margin-top:16px">รายการผลิตภัณฑ์/ทะเบียน</div>

      <!-- แถวตัวกรองค้นหา -->
      <div class="row" style="gap:8px">
        <input id="itSearch" placeholder="ค้นหา: ชื่อการค้า/ชื่อสามัญ/ทะเบียน/เลขรับ" style="flex:1">
        <select id="itFilterStatus">
          <option value="">ทุกสถานะ</option>
          <option value="waiting_docs">รอเอกสาร</option>
          <option value="precheck">ตรวจเบื้องต้น</option>
          <option value="submitted">ยื่นแล้ว</option>
          <option value="pending_result">รอผล</option>
          <option value="done">เสร็จสิ้น</option>
          <option value="rejected">ถูกตีกลับ</option>
        </select>
        <label class="pill" style="cursor:pointer">
          <input type="checkbox" id="itOnlyBlocker" style="accent-color:#22d3ee"> เฉพาะที่มีปัญหา
        </label>
      </div>

      <div class="row">
        <input id="itTrade" placeholder="ชื่อการค้า">
        <input id="itCommon" placeholder="ชื่อสามัญ">
        <input id="itReg" placeholder="ทะเบียน">
        <input id="itReceipt" placeholder="เลขรับ">
        <select id="itStep">
          <option value="waiting_docs">รอเอกสาร</option>
          <option value="precheck">ตรวจเบื้องต้น</option>
          <option value="submitted">ยื่นแล้ว</option>
          <option value="pending_result">รอผล</option>
          <option value="done">เสร็จสิ้น</option>
          <option value="rejected">ถูกตีกลับ</option>
        </select>
        <input id="itAdminNote" placeholder="หมายเหตุ (ฝั่งเรา)">
        <button id="btnAddItem">+ เพิ่มรายการ</button>
      </div>

      <div id="items"></div>
      <div class="h">Log</div>
      <div class="log" id="log"></div>
    </div>
  </div>
</div>
</div> <!-- /#mainWrap -->

<script>
/* ===== Config (ฝังคีย์จริง) ===== */
const SUPABASE_URL = 'https://jlrogimfjmtwdqiuyejj.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impscm9naW1mam10d2RxaXV5ZWpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NDIyODUsImV4cCI6MjA3NTUxODI4NX0.OvX7qgcIF5aCcLebUEUR_6D2KTUP2pALCjRtHWJ5qZg';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== Helpers ===== */
let selectedProject = null;
const el = id => document.getElementById(id);
const log = (...a) => { const t = el('log'); if(!t) return; t.textContent = [new Date().toLocaleString(), ...a].join(' | ') + "\n" + t.textContent; };

/* ===== Auth & PIN (ชั้นความปลอดภัย) ===== */
function msg(id, text){ const n = document.getElementById(id); if(n) n.textContent = text || ''; }

async function signIn(){
  const email = el('email').value.trim();
  const password = el('password').value;
  if(!email || !password){ return msg('authMsg','กรอกอีเมลและรหัสผ่าน'); }
  const { error } = await sb.auth.signInWithPassword({ email, password });
  if(error){ return msg('authMsg','เข้าสู่ระบบไม่สำเร็จ: ' + error.message); }
}

async function signOut(){
  await sb.auth.signOut();
  sessionStorage.removeItem('adminPinOk');
  location.reload();
}

function toggleMain(show){
  el('mainWrap').style.display = show ? 'block' : 'none';
}

async function ensureAdminPin(){
  if(sessionStorage.getItem('adminPinOk') === '1'){ return true; }
  el('pinModal').style.display = 'flex';
  return false;
}

async function verifyPin(){
  const pin = el('adminPin').value;
  if(!pin){ return msg('pinMsg','ใส่ PIN ก่อน'); }
  const { data, error } = await sb.rpc('verify_admin_pin', { p_pin: pin });
  if(error){ return msg('pinMsg','ตรวจ PIN ไม่สำเร็จ: ' + error.message); }
  if(!data){ return msg('pinMsg','PIN ไม่ถูกต้อง'); }
  sessionStorage.setItem('adminPinOk','1');
  el('pinModal').style.display = 'none';
  msg('pinMsg','');
  // PIN ผ่านแล้ว ค่อยโหลดข้อมูล
  await listAll();
  return true;
}

async function setPin(){
  const newPin = prompt('ตั้ง/เปลี่ยน Admin PIN (อย่างน้อย 6 หลัก):');
  if(!newPin) return;
  if(newPin.length < 6){ alert('PIN ควรมีอย่างน้อย 6 หลัก'); return; }
  const { error } = await sb.rpc('set_admin_pin', { p_pin: newPin });
  if(error){ alert('ตั้ง PIN ไม่สำเร็จ: ' + error.message); return; }
  alert('ตั้ง/เปลี่ยน PIN เรียบร้อย');
}

async function guardAdminStaff() {
  const { data: s } = await sb.auth.getSession();
  if(!s.session){
    toggleMain(false);
    msg('authMsg','ยังไม่ได้ล็อกอินทีมงาน');
    return false;
  }
  const uid = s.session.user.id;
  const { data, error } = await sb
    .from('memberships')
    .select('role')
    .eq('user_id', uid)
    .limit(1);
  if(error || !data || data.length===0){
    toggleMain(false);
    msg('authMsg','บัญชีนี้ไม่มีสิทธิ์ทีมงาน');
    return false;
  }
  const role = data[0].role;
  if(!(role === 'admin' || role === 'staff')){
    toggleMain(false);
    msg('authMsg','หน้านี้สำหรับทีมงานเท่านั้น');
    return false;
  }
  // ผ่าน role แล้ว → ตรวจ PIN
  const okPin = await ensureAdminPin();
  toggleMain(okPin);
  return okPin;
}

async function afterAuth(){
  const { data: s } = await sb.auth.getSession();
  const signedIn = !!s.session;
  el('btnSignIn').style.display = signedIn ? 'none' : '';
  el('btnSignOut').style.display = signedIn ? '' : 'none';
  if(signedIn){
    msg('authMsg','เข้าสู่ระบบแล้ว');
    await guardAdminStaff();
  } else {
    toggleMain(false);
  }
}

/* ===== Core Admin Functions ===== */
async function ensureSession() {
  const { data } = await sb.auth.getSession();
  if(!data.session) log('ยังไม่ได้ล็อกอิน (โปรดต่อ auth ที่ production)');
}

async function listAll() {
  const q = el('search').value?.trim()?.toLowerCase();
  let { data: rows, error } = await sb
    .from('projects')
    .select('id,title,status,due_date,company_id,companies:company_id(name,code)')
    .order('created_at', { ascending:false });

  if(error){ log('โหลดโปรเจ็กต์ผิดพลาด', error.message); return; }
  if(q){
    rows = rows.filter(r =>
      r.title.toLowerCase().includes(q) ||
      (r.companies?.name||'').toLowerCase().includes(q) ||
      (r.companies?.code||'').toLowerCase().includes(q)
    );
  }
  const list = el('list'); list.innerHTML='';
  (rows||[]).forEach(r=>{
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `<div><strong>${r.title}</strong></div>
      <div class="muted">${r.companies?.name || '-'} • สถานะ: ${r.status} • กำหนด: ${r.due_date||'-'}</div>`;
    div.onclick = ()=>selectProject(r);
    list.appendChild(div);
  });
}

function paintProject(p){
  selectedProject = p;
  el('pStatus').textContent = p.status;
  el('pDue').textContent = p.due_date || '-';
  el('pCompany').textContent = p.companies?.name || '-';
  el('updStatus').value = p.status;
}

async function selectProject(p) {
  document.querySelectorAll('.item').forEach(i=>i.classList.remove('active'));
  const list = el('list'); const idx = Array.from(list.children).findIndex(n => n.textContent.includes(p.title));
  if(idx>=0) list.children[idx].classList.add('active');

  paintProject(p);
  await loadTimeline();
  await loadMessages();
  await loadDocs();
  await loadItems();
}

async function addCompany(){
  const name = el('companyName').value.trim();
  const code = el('companyCode').value.trim();
  if(!name || !code) return log('กรอกชื่อ/รหัสบริษัท');
  const { data, error } = await sb.from('companies').insert({ name, code }).select().maybeSingle();
  if(error) return log('เพิ่มบริษัทผิดพลาด', error.message);
  el('companyName').value=''; el('companyCode').value='';
  log('เพิ่มบริษัทแล้ว', data?.name);
  await listAll();
}

async function addProject(){
  const title = el('projTitle').value.trim();
  const status = el('projStatus').value;
  const due = el('projDue').value || null;

  const { data: firstCo } = await sb.from('companies').select('id,name').order('created_at').limit(1).maybeSingle();
  if(!firstCo) return log('ยังไม่มีบริษัท ให้สร้างก่อน');

  const { data: pj, error } = await sb.from('projects').insert({
    company_id: firstCo.id, title, status, due_date: due
  }).select('id,title,status,due_date,company_id,companies:company_id(name,code)').maybeSingle();

  if(error) return log('เพิ่มโปรเจ็กต์ผิดพลาด', error.message);
  el('projTitle').value=''; el('projDue').value='';
  log('เพิ่มโปรเจ็กต์แล้ว', pj?.title);
  await listAll();
  await selectProject(pj);
}

async function updateStatus(){
  if(!selectedProject) return;
  const status = el('updStatus').value;
  const { error } = await sb.from('projects').update({ status }).eq('id', selectedProject.id);
  if(error) return log('อัปเดตสถานะผิดพลาด', error.message);
  selectedProject.status = status;
  paintProject(selectedProject);
  await sb.from('timeline').insert({ project_id: selectedProject.id, step: `อัปเดตสถานะ: ${status}`, note: null });
  await loadTimeline();
  log('อัปเดตสถานะสำเร็จ');
}

async function addTimeline(){
  if(!selectedProject) return;
  const step = el('tlStep').value.trim();
  const note = el('tlNote').value.trim() || null;
  if(!step) return log('ระบุข้อความขั้นตอน');
  const { error } = await sb.from('timeline').insert({ project_id: selectedProject.id, step, note });
  if(error) return log('เพิ่มไทม์ไลน์ผิดพลาด', error.message);
  el('tlStep').value=''; el('tlNote').value='';
  await loadTimeline();
  log('เพิ่มไทม์ไลน์แล้ว');
}

async function loadTimeline(){
  if(!selectedProject) return;
  const { data, error } = await sb.from('timeline')
    .select('id,step,note,created_at')
    .eq('project_id', selectedProject.id)
    .order('created_at',{ascending:false});
  if(error) return log('โหลดไทม์ไลน์ผิดพลาด', error.message);
  el('timeline').innerHTML = (data||[]).map(x=>`
    <div class="item">
      <div><strong>${x.step}</strong></div>
      <div class="muted">${new Date(x.created_at).toLocaleString()}</div>
      ${x.note? `<div class="muted">${x.note}</div>`:''}
    </div>
  `).join('');
}

async function addMsg(){
  if(!selectedProject) return;
  const body = el('msgBody').value.trim();
  if(!body) return log('พิมพ์ข้อความก่อน');
  const { error } = await sb.from('messages').insert({
    project_id: selectedProject.id, body, by_role: 'staff'
  });
  if(error) return log('โพสต์ข้อความผิดพลาด', error.message);
  el('msgBody').value='';
  await loadMessages();
  log('โพสต์แล้ว');
}

async function loadMessages(){
  if(!selectedProject) return;
  const { data, error } = await sb.from('messages')
    .select('id,body,by_role,created_at')
    .eq('project_id', selectedProject.id)
    .order('created_at',{ascending:false});
  if(error) return log('โหลดข้อความผิดพลาด', error.message);
  el('messages').innerHTML = (data||[]).map(x=>`
    <div class="item">
      <div><strong>[${x.by_role}]</strong> ${x.body}</div>
      <div class="muted">${new Date(x.created_at).toLocaleString()}</div>
    </div>
  `).join('');
}

async function uploadDoc(){
  if(!selectedProject) return;
  const f = el('docFile').files[0];
  if(!f) return log('เลือกไฟล์ก่อน');
  const label = el('docLabel').value.trim() || f.name;
  const path = `${selectedProject.id}/${Date.now()}_${f.name}`;
  const { error: e1 } = await sb.storage.from('docs').upload(path, f, { upsert:false });
  if(e1) return log('อัปโหลดไฟล์ผิดพลาด', e1.message);
  const { error: e2 } = await sb.from('documents').insert({ project_id: selectedProject.id, file_path: path, label });
  if(e2) return log('บันทึกไฟล์ผิดพลาด', e2.message);
  el('docFile').value=''; el('docLabel').value='';
  await loadDocs();
  log('อัปโหลดแล้ว');
}

async function loadDocs(){
  if(!selectedProject) return;
  const { data, error } = await sb.from('documents')
    .select('id,label,file_path,created_at')
    .eq('project_id', selectedProject.id)
    .order('created_at',{ascending:false});
  if(error) return log('โหลดไฟล์ผิดพลาด', error.message);

  const html = await Promise.all((data||[]).map(async d=>{
    const { data: signed } = await sb.storage.from('docs').createSignedUrl(d.file_path, 60*10);
    return `<div class="item">
      <div><strong>${d.label||'ไฟล์'}</strong></div>
      <div class="muted">${new Date(d.created_at).toLocaleString()}</div>
      <div class="row"><a href="${signed?.signedUrl||'#'}" target="_blank">เปิดไฟล์</a></div>
    </div>`;
  }));
  el('docs').innerHTML = html.join('');
}

/* ===== Product Items: ค้น/กรอง + CRUD ===== */
async function addItem(){
  if(!selectedProject) return;
  const payload = {
    project_id: selectedProject.id,
    trade_name: el('itTrade').value.trim() || null,
    common_name: el('itCommon').value.trim() || null,
    reg_no: el('itReg').value.trim() || null,
    receipt_no: el('itReceipt').value.trim() || null,
    status_step: el('itStep').value || null,
    admin_note: el('itAdminNote').value.trim() || null,
    blocker: false,
    blocker_note: null
  };
  const { error } = await sb.from('product_items').insert(payload);
  if(error) return log('เพิ่มรายการผลิตภัณฑ์ผิดพลาด', error.message);
  ['itTrade','itCommon','itReg','itReceipt','itAdminNote'].forEach(id=>el(id).value='');
  await loadItems();
  log('เพิ่มรายการผลิตภัณฑ์แล้ว');
}

async function editItem(id){
  const { data: cur } = await sb.from('product_items').select('*').eq('id', id).maybeSingle();
  if(!cur) return log('ไม่พบบรรทัด');
  const trade = prompt('ชื่อการค้า', cur.trade_name ?? '') ?? cur.trade_name;
  const common = prompt('ชื่อสามัญ', cur.common_name ?? '') ?? cur.common_name;
  const reg = prompt('ทะเบียน', cur.reg_no ?? '') ?? cur.reg_no;
  const rcpt = prompt('เลขรับ', cur.receipt_no ?? '') ?? cur.receipt_no;
  const step = prompt('ขั้นตอน (waiting_docs/precheck/submitted/pending_result/done/rejected)', cur.status_step ?? '') ?? cur.status_step;
  const anote = prompt('หมายเหตุ (ฝั่งเรา)', cur.admin_note ?? '') ?? cur.admin_note;
  const blocker = confirm('ติ๊ก "ตกลง" หากรายการนี้มีปัญหา (blocker)') ? true : false;
  const bnote = blocker ? (prompt('ระบุปัญหา/สิ่งที่ค้าง', cur.blocker_note ?? '') ?? cur.blocker_note) : null;

  const { error } = await sb.from('product_items').update({
    trade_name: trade || null,
    common_name: common || null,
    reg_no: reg || null,
    receipt_no: rcpt || null,
    status_step: step || null,
    admin_note: anote || null,
    blocker,
    blocker_note: bnote
  }).eq('id', id);

  if(error) return log('แก้ไขรายการผลิตภัณฑ์ผิดพลาด', error.message);
  await loadItems();
  log('แก้ไขรายการผลิตภัณฑ์แล้ว');
}

async function delItem(id){
  if(!confirm('ลบรายการนี้ใช่ไหม?')) return;
  const { error } = await sb.from('product_items').delete().eq('id', id);
  if(error) return log('ลบรายการผลิตภัณฑ์ผิดพลาด', error.message);
  await loadItems();
  log('ลบรายการผลิตภัณฑ์แล้ว');
}

async function loadItems(){
  if(!selectedProject) return;
  const kw = (el('itSearch').value || '').trim().toLowerCase();
  const status = el('itFilterStatus').value || '';
  const onlyBlocker = el('itOnlyBlocker').checked;

  const { data, error } = await sb
    .from('product_items')
    .select('id,trade_name,common_name,reg_no,receipt_no,status_step,admin_note,client_note,blocker,blocker_note,updated_at')
    .eq('project_id', selectedProject.id)
    .order('created_at',{ascending:false});
  if(error){ log('โหลดรายการผลิตภัณฑ์ผิดพลาด', error.message); return; }

  let rows = data || [];
  if(kw){
    rows = rows.filter(x=>{
      const s = [x.trade_name,x.common_name,x.reg_no,x.receipt_no,x.admin_note,x.client_note,x.blocker_note]
        .filter(Boolean).join(' ').toLowerCase();
      return s.includes(kw);
    });
  }
  if(status) rows = rows.filter(x => (x.status_step||'') === status);
  if(onlyBlocker) rows = rows.filter(x => x.blocker);

  el('items').innerHTML = rows.map(x=>`
    <div class="item">
      <div><strong>${x.trade_name||'-'}</strong> <span class="muted">(${x.common_name||'-'})</span></div>
      <div class="muted">ทะเบียน: ${x.reg_no||'-'} • เลขรับ: ${x.receipt_no||'-'} • ขั้น: ${x.status_step||'-'}</div>
      <div class="muted">ปัญหา: ${x.blocker ? 'มี' : 'ไม่มี'} ${x.blocker && x.blocker_note ? '— '+x.blocker_note : ''}</div>
      <div class="muted">หมายเหตุเรา: ${x.admin_note||'-'} | หมายเหตุลูกค้า: ${x.client_note||'-'}</div>
      <div class="muted">อัปเดตล่าสุด: ${new Date(x.updated_at).toLocaleString()}</div>
      <div class="row" style="margin-top:6px; gap:6px">
        <button onclick="editItem('${x.id}')">แก้ไข</button>
        <button onclick="delItem('${x.id}')">ลบ</button>
      </div>
    </div>
  `).join('');
}

/* ===== Bindings & Realtime ===== */
document.addEventListener('DOMContentLoaded', async ()=>{
  // ปุ่ม auth & PIN
  el('btnSignIn').onclick = signIn;
  el('btnSignOut').onclick = signOut;
  el('btnVerifyPin').onclick = verifyPin;
  el('btnSetPin').onclick = setPin;

  // auth state
  sb.auth.onAuthStateChange(afterAuth);
  await afterAuth(); // จะเรียก guardAdminStaff ภายในถ้าล็อกอินแล้ว

  // กดปุ่มต่าง ๆ
  el('btnRefresh').onclick = listAll;
  el('btnAddCompany').onclick = addCompany;
  el('btnAddProject').onclick = addProject;
  el('btnUpdateStatus').onclick = updateStatus;
  el('btnAddTimeline').onclick = addTimeline;
  el('btnAddMsg').onclick = addMsg;
  el('btnUpload').onclick = uploadDoc;
  el('btnAddItem').onclick = addItem;
  el('search').oninput = listAll;

  ['itSearch','itFilterStatus','itOnlyBlocker'].forEach(id=>{
    const n = el(id); if(n) n.oninput = loadItems;
  });

  // realtime subscribe
  sb.channel('rt-admin')
    .on('postgres_changes', { event:'*', schema:'public', table:'timeline' }, payload => {
      if(selectedProject && payload.new.project_id === selectedProject.id){ loadTimeline(); }
    })
    .on('postgres_changes', { event:'*', schema:'public', table:'messages' }, payload => {
      if(selectedProject && payload.new.project_id === selectedProject.id){ loadMessages(); }
    })
    .on('postgres_changes', { event:'*', schema:'public', table:'documents' }, payload => {
      if(selectedProject && payload.new.project_id === selectedProject.id){ loadDocs(); }
    })
    .on('postgres_changes', { event:'*', schema:'public', table:'product_items' }, payload => {
      if(selectedProject && payload.new.project_id === selectedProject.id){ loadItems(); }
    })
    .subscribe();
});
</script>
</body>
</html>
