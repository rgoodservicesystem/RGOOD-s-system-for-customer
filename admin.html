<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£</title>

<!-- Supabase UMD -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #059669;
  --primary-dark: #047857;
  --secondary: #3b82f6;
  --bg-main: #f8fafc;
  --bg-card: #ffffff;
  --text-primary: #1e293b;
  --text-secondary: #64748b;
  --border: #e2e8f0;
  --shadow: 0 1px 3px rgba(0,0,0,0.1);
  --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
  --warning: #f59e0b;
  --danger: #ef4444;
  --success: #10b981;
}

/* reset */
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: "Prompt", sans-serif;
  background: var(--bg-main);
  color: var(--text-primary);
  line-height: 1.6;
}

/* Page Transitions */
.page { display: none; animation: fadeIn 0.4s ease-in-out;}
.page.active { display: block; }
@keyframes fadeIn { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }

/* ===== LOGIN PAGE ===== */
.login-page {
  min-height: 100vh; display:flex; align-items:center; justify-content:center;
  background: linear-gradient(135deg, #0f766e 0%, #059669 50%, #34d399 100%);
  padding: 20px; position: relative; overflow: hidden;
}
.login-page::before,.login-page::after{content:""; position:absolute; border-radius:50%;}
.login-page::before{width:500px;height:500px;background:rgba(255,255,255,0.1); top:-250px; right:-250px;}
.login-page::after{width:400px;height:400px;background:rgba(255,255,255,0.05); bottom:-200px; left:-200px;}

.login-container{position:relative; z-index:1; width:100%; max-width:480px;}
.login-card{
  background: var(--bg-card); padding:48px 40px; border-radius:24px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.2);
}
.login-header{text-align:center; margin-bottom:40px;}
.login-icon{
  width:80px; height:80px; background: linear-gradient(135deg, var(--primary), #34d399);
  border-radius:20px; display:flex; align-items:center; justify-content:center; font-size:40px;
  margin:0 auto 20px; box-shadow: 0 10px 30px rgba(5,150,105,0.3);
}
.login-title{font-size:28px; font-weight:700; color:var(--text-primary); margin-bottom:8px;}
.login-subtitle{color:var(--text-secondary); font-size:15px;}

.input-group{margin-bottom:24px;}
.input-label{display:block; margin-bottom:8px; color:var(--text-primary); font-weight:500; font-size:14px;}
.input-wrapper{position:relative;}
.input-icon{position:absolute; left:16px; top:50%; transform:translateY(-50%); color:var(--text-secondary); font-size:18px;}
.form-input{
  width:100%; padding:14px 16px 14px 48px; border:2px solid var(--border); border-radius:12px;
  font-size:15px; font-family:"Prompt",sans-serif; transition:all .3s; background: var(--bg-main);
}
.form-input:focus{outline:none; border-color:var(--primary); background:#fff; box-shadow:0 0 0 4px rgba(5,150,105,.1)}

.btn{
  padding:14px 24px; border-radius:12px; border:none; font-weight:600; cursor:pointer; transition:all .3s;
  font-family:"Prompt",sans-serif; font-size:15px; display:inline-flex; align-items:center; justify-content:center; gap:8px;
}
.btn-primary{background:var(--primary); color:#fff; width:100%; padding:16px; font-size:16px;}
.btn-primary:hover{background:var(--primary-dark); transform:translateY(-2px); box-shadow:0 10px 30px rgba(5,150,105,.3)}
.btn-primary:active{transform:none}
.btn-primary:disabled{opacity:.6; cursor:not-allowed; transform:none}
.btn-secondary{background:var(--secondary); color:#fff;}
.btn-secondary:hover{background:#2563eb; transform:translateY(-2px); box-shadow:var(--shadow-lg)}
.btn-outline{background:#fff; border:2px solid var(--border); color:var(--text-primary);}
.btn-outline:hover{border-color:var(--primary); background:rgba(5,150,105,.05)}
.btn-danger{background:var(--danger); color:#fff;}
.btn-danger:hover{background:#dc2626}

.alert{margin-top:20px; padding:14px 16px; border-radius:12px; font-size:14px; text-align:center; animation:slideDown .3s ease-out;}
@keyframes slideDown{from{opacity:0; transform:translateY(-10px)} to{opacity:1; transform:translateY(0)}}
.alert-error{background:#fee; color:var(--danger); border:1px solid #fcc;}
.alert-success{background:#efe; color:var(--success); border:1px solid #cfc;}
.alert-info{background:#e0f2fe; color:#0369a1; border:1px solid #bae6fd;}

/* PIN Modal */
.modal-overlay{position:fixed; inset:0; background:rgba(0,0,0,.7); display:none; align-items:center; justify-content:center; z-index:9999; backdrop-filter:blur(8px); animation:fadeIn .3s ease-out;}
.modal-overlay.show{display:flex;}
.modal-content{background:var(--bg-card); padding:40px; border-radius:20px; max-width:450px; width:90%; box-shadow:0 20px 60px rgba(0,0,0,.3); animation:scaleIn .3s ease-out;}
@keyframes scaleIn{from{opacity:0; transform:scale(.9)} to{opacity:1; transform:scale(1)}}
.modal-header{text-align:center; margin-bottom:30px;}
.modal-icon{width:64px; height:64px; background:linear-gradient(135deg,#3b82f6,#60a5fa); border-radius:16px; display:flex; align-items:center; justify-content:center; font-size:32px; margin:0 auto 16px;}
.modal-title{font-size:22px; font-weight:700; color:var(--text-primary); margin-bottom:8px;}
.modal-subtitle{color:var(--text-secondary); font-size:14px;}
.modal-actions{display:flex; flex-direction:column; gap:12px; margin-top:20px;}

/* ===== MAIN APP PAGE ===== */
.app-page{min-height:100vh; display:flex; flex-direction:column}

/* Header */
.header{background:var(--bg-card); border-bottom:1px solid var(--border); padding:20px 24px; box-shadow:var(--shadow); position:sticky; top:0; z-index:100;}
.header-content{max-width:1400px; margin:0 auto; display:flex; justify-content:space-between; align-items:center; gap:20px; flex-wrap:wrap;}
.header-left{display:flex; align-items:center; gap:16px;}
.header-logo{width:48px; height:48px; background:linear-gradient(135deg,var(--primary),#34d399); border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:24px; box-shadow:0 4px 12px rgba(5,150,105,.2);}
.header-title{font-size:20px; color:var(--primary); font-weight:700;}
.header-right{display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
.badge{display:inline-flex; align-items:center; gap:6px; padding:8px 16px; border-radius:20px; font-size:13px; font-weight:500;}
.badge-user{background:#e0f2fe; color:#0369a1;}
.badge-role{background:#f0fdf4; color:var(--primary);}

/* Container */
.container{flex:1; max-width:1400px; margin:0 auto; padding:32px 24px; width:100%;}

/* Company Sections */
.add-section{background:linear-gradient(135deg, rgba(5,150,105,.05), rgba(52,211,153,.05)); border:2px dashed var(--primary); border-radius:16px; padding:24px; margin-bottom:32px;}
.add-section-title{font-size:18px; font-weight:600; color:var(--primary); margin-bottom:16px; display:flex; align-items:center; gap:8px;}

.search-bar{margin-bottom:32px; position:relative;}
.search-input{width:100%; padding:16px 20px 16px 56px; border:2px solid var(--border); border-radius:16px; font-size:16px; font-family:"Prompt",sans-serif; background:var(--bg-card); box-shadow:var(--shadow); transition:all .3s;}
.search-input:focus{outline:none; border-color:var(--primary); box-shadow:0 0 0 4px rgba(5,150,105,.1)}
.search-icon{position:absolute; left:20px; top:50%; transform:translateY(-50%); font-size:24px; color:var(--text-secondary);}

.company-section{background:var(--bg-card); border-radius:20px; padding:32px; margin-bottom:32px; box-shadow:var(--shadow-lg); border:2px solid var(--border); transition:all .3s;}
.company-section:hover{box-shadow:0 15px 40px rgba(0,0,0,.12);}
.company-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; padding-bottom:20px; border-bottom:2px solid var(--border); flex-wrap:wrap; gap:16px;}
.company-title{display:flex; align-items:center; gap:16px;}
.company-icon{width:56px; height:56px; background:linear-gradient(135deg,var(--primary),#34d399); border-radius:16px; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; font-size:24px; box-shadow:0 8px 24px rgba(5,150,105,.25);}
.company-info h2{font-size:24px; color:var(--text-primary); margin-bottom:4px;}
.company-code{color:var(--text-secondary); font-size:14px; font-weight:500;}
.company-meta{display:flex; gap:20px; align-items:center; flex-wrap:wrap;}
.company-stats{display:flex; gap:16px; flex-wrap:wrap;}
.stat-item{padding:10px 20px; background:var(--bg-main); border-radius:12px; font-size:14px; border:1px solid var(--border);}
.stat-label{color:var(--text-secondary); margin-right:6px;}
.stat-value{font-weight:700; color:var(--text-primary); font-size:16px;}

/* Projects Grid */
.projects-grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(320px,1fr)); gap:20px; margin-top:20px;}
.project-card{background:var(--bg-main); border:2px solid var(--border); border-radius:16px; padding:24px; cursor:pointer; transition:all .3s; position:relative; overflow:hidden;}
.project-card::before{content:""; position:absolute; top:0; left:0; right:0; height:4px; background:linear-gradient(90deg,var(--primary),#34d399); transform:scaleX(0); transition:transform .3s;}
.project-card:hover{transform:translateY(-8px); box-shadow:0 12px 32px rgba(0,0,0,.12); border-color:var(--primary);}
.project-card:hover::before{transform:scaleX(1);}
.project-card.selected{border-color:var(--primary); background:linear-gradient(135deg, rgba(5,150,105,.05), rgba(52,211,153,.03)); box-shadow:0 8px 24px rgba(5,150,105,.15);}
.project-card.selected::before{transform:scaleX(1);}
.project-header{display:flex; justify-content:space-between; align-items:start; margin-bottom:16px; gap:12px;}
.project-title{font-size:18px; font-weight:600; color:var(--text-primary); flex:1; line-height:1.4;}
.status-badge{padding:6px 14px; border-radius:12px; font-size:12px; font-weight:600; white-space:nowrap;}
.status-waiting_docs{background:#fef3c7; color:#92400e;}
.status-precheck{background:#dbeafe; color:#1e40af;}
.status-submitted{background:#e0e7ff; color:#4338ca;}
.status-pending_result{background:#fce7f3; color:#9f1239;}
.status-done{background:#d1fae5; color:#065f46;}
.status-rejected{background:#fee2e2; color:#991b1b;}
.project-meta{display:flex; gap:16px; color:var(--text-secondary); font-size:13px;}
.meta-item{display:flex; align-items:center; gap:6px;}

/* Detail Panel */
.detail-panel{background:var(--bg-card); border-radius:20px; padding:32px; box-shadow:var(--shadow-lg); border:2px solid var(--border); display:none; margin-top:32px;}
.detail-panel.show{display:block; animation:slideUp .4s ease-out;}
@keyframes slideUp{from{opacity:0; transform:translateY(30px)} to{opacity:1; transform:translateY(0)}}
.detail-header{margin-bottom:32px; padding-bottom:24px; border-bottom:2px solid var(--border);}
.detail-title{font-size:28px; font-weight:700; color:var(--text-primary); margin-bottom:16px;}
.detail-meta{display:flex; gap:12px; flex-wrap:wrap;}
.section{margin-bottom:40px;}
.section-title{font-size:20px; font-weight:600; color:var(--text-primary); margin-bottom:20px; display:flex; align-items:center; gap:12px;}
.section-icon{width:40px; height:40px; background:linear-gradient(135deg,var(--primary),#34d399); border-radius:10px; display:flex; align-items:center; justify-content:center; color:#fff; font-size:18px; box-shadow:0 4px 12px rgba(5,150,105,.2);}

/* Forms */
.form-row{display:flex; gap:12px; margin-bottom:16px; flex-wrap:wrap;}
.form-row input,.form-row select,.form-row textarea{
  padding:12px 16px; border:2px solid var(--border); border-radius:10px; font-family:"Prompt",sans-serif; font-size:14px; transition:all .3s; background:var(--bg-main);
}
.form-row input:focus,.form-row select:focus,.form-row textarea:focus{outline:none; border-color:var(--primary); background:#fff; box-shadow:0 0 0 3px rgba(5,150,105,.1)}
.form-row input[type="text"], .form-row input[type="date"]{flex:1; min-width:200px;}
.form-row textarea{flex:1; min-width:100%; resize:vertical;}

/* Timeline */
.timeline{position:relative; padding-left:40px; margin-top:24px;}
.timeline::before{content:""; position:absolute; left:12px; top:0; bottom:0; width:3px; background:linear-gradient(180deg,var(--primary),#34d399);}
.timeline-item{position:relative; margin-bottom:24px; padding:20px; background:var(--bg-main); border-radius:12px; border-left:4px solid var(--primary); transition:all .3s;}
.timeline-item:hover{box-shadow:var(--shadow); transform:translateX(4px);}
.timeline-item::before{content:""; position:absolute; left:-48px; top:24px; width:20px; height:20px; background:var(--primary); border-radius:50%; border:4px solid var(--bg-card); box-shadow:0 0 0 2px var(--primary);}
.timeline-step{font-weight:600; color:var(--text-primary); margin-bottom:8px; font-size:15px;}
.timeline-note{color:var(--text-secondary); font-size:14px; margin-bottom:8px; line-height:1.6;}
.timeline-date{color:var(--text-secondary); font-size:12px; font-weight:500;}

/* Messages */
.message-list{display:flex; flex-direction:column; gap:16px; margin-top:24px;}
.message-item{padding:20px; background:var(--bg-main); border-radius:12px; border-left:4px solid var(--secondary); transition:all .3s;}
.message-item:hover{box-shadow:var(--shadow);}
.message-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;}
.message-role{font-weight:600; color:var(--secondary); font-size:14px; display:flex; align-items:center; gap:6px;}
.message-date{color:var(--text-secondary); font-size:12px;}
.message-body{color:var(--text-primary); line-height:1.6;}

/* Documents */
.doc-list{display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:16px; margin-top:24px;}
.doc-item{padding:20px; background:var(--bg-main); border:2px solid var(--border); border-radius:12px; transition:all .3s;}
.doc-item:hover{border-color:var(--primary); box-shadow:var(--shadow); transform:translateY(-4px);}
.doc-label{font-weight:600; color:var(--text-primary); margin-bottom:8px; font-size:15px;}
.doc-date{color:var(--text-secondary); font-size:12px; margin-bottom:16px;}

/* Products */
.filter-bar{display:flex; gap:12px; margin-bottom:20px; flex-wrap:wrap; align-items:center; padding:16px; background:var(--bg-main); border-radius:12px;}
.checkbox-label{display:flex; align-items:center; gap:8px; padding:10px 16px; background:#fff; border:2px solid var(--border); border-radius:10px; cursor:pointer; font-size:14px; transition:all .3s;}
.checkbox-label:hover{border-color:var(--primary);}
.checkbox-label input{accent-color:var(--primary); width:18px; height:18px;}
.product-item{padding:24px; background:var(--bg-main); border:2px solid var(--border); border-radius:16px; margin-bottom:20px; transition:all .3s;}
.product-item:hover{box-shadow:var(--shadow-lg);}
.product-header{display:flex; justify-content:space-between; align-items:start; margin-bottom:20px; gap:16px;}
.product-names{flex:1;}
.product-trade{font-weight:600; font-size:16px; color:var(--text-primary); margin-bottom:4px;}
.product-common{color:var(--text-secondary); font-size:14px;}
.product-names input{width:100%; margin-bottom:8px;}
.blocker-badge{background:var(--danger); color:#fff; padding:8px 16px; border-radius:10px; font-size:13px; font-weight:600; display:flex; align-items:center; gap:6px;}
.product-fields{display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:16px; margin-bottom:20px;}
.field-group{display:flex; flex-direction:column;}
.field-label{font-size:12px; color:var(--text-secondary); margin-bottom:8px; font-weight:600; text-transform:uppercase; letter-spacing:.5px;}
.product-actions{display:flex; gap:12px; margin-top:16px; padding-top:16px; border-top:1px solid var(--border);}

/* Empty State */
.empty-state{text-align:center; padding:80px 20px; color:var(--text-secondary);}
.empty-icon{font-size:72px; margin-bottom:20px; opacity:.3;}
.empty-text{font-size:16px; line-height:1.6;}

/* Responsive */
@media (max-width: 768px){
  .header-content{flex-direction:column; align-items:flex-start;}
  .header-right{width:100%; justify-content:space-between;}
  .projects-grid{grid-template-columns:1fr;}
  .form-row{flex-direction:column;}
  .product-fields{grid-template-columns:1fr;}
  .company-header{flex-direction:column; align-items:flex-start;}
  .company-stats{width:100%;}
  .login-card{padding:32px 24px;}
}

.hidden{display:none;}
</style>
</head>
<body>

<!-- ===== LOGIN PAGE ===== -->
<div class="page active" id="loginPage">
  <div class="login-page">
    <div class="login-container">
      <div class="login-card">
        <div class="login-header">
          <div class="login-icon">üåæ</div>
          <h1 class="login-title">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h1>
          <p class="login-subtitle">‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£ - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô</p>
        </div>

        <div class="input-group">
          <label class="input-label">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
          <div class="input-wrapper">
            <span class="input-icon">üë§</span>
            <input type="email" id="email" class="form-input" placeholder="your@email.com" autocomplete="email">
          </div>
        </div>
        
        <div class="input-group">
          <label class="input-label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
          <div class="input-wrapper">
            <span class="input-icon">üîí</span>
            <input type="password" id="password" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
          </div>
        </div>
        
        <button class="btn btn-primary" id="btnSignIn">
          <span>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span>
          <span>‚Üí</span>
        </button>
        
        <div id="authMsg"></div>
      </div>
    </div>
  </div>
</div>

<!-- ===== PIN MODAL ===== -->
<div class="modal-overlay" id="pinModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-icon">üîê</div>
      <h3 class="modal-title">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Admin PIN</h3>
      <p class="modal-subtitle">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà PIN 6 ‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏ö‡∏ö</p>
    </div>

    <div class="input-group">
      <div class="input-wrapper">
        <span class="input-icon">üî¢</span>
        <input type="password" id="adminPin" class="form-input" placeholder="PIN 6 ‡∏´‡∏•‡∏±‡∏Å" maxlength="6"
               inputmode="numeric" pattern="[0-9]*" autocomplete="one-time-code">
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-primary" id="btnVerifyPin">‚úì ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
      <button class="btn btn-outline" id="btnSetPin">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á/‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô PIN (Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</button>
    </div>

    <div id="pinMsg"></div>
  </div>
</div>

<!-- ===== MAIN APP PAGE ===== -->
<div class="page" id="appPage">
  <div class="app-page">
    <!-- Header -->
    <div class="header">
      <div class="header-content">
        <div class="header-left">
          <div class="header-logo">üåæ</div>
          <h1 class="header-title">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£</h1>
        </div>
        <div class="header-right">
          <span class="badge badge-user" id="whoEmail">üë§ ‚Äî</span>
          <span class="badge badge-role" id="whoRole">üé≠ ‚Äî</span>
          <button class="btn btn-outline" id="btnSignOut2">
            <span>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
            <span>‚Üí</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="container">
      <!-- Client Management Section -->
      <div class="add-section" style="margin-bottom: 24px;">
        <div class="add-section-title">
          <span>üë•</span>
          <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span>
        </div>
        <div class="form-row">
          <select id="clientCompanyId" style="flex: 1; min-width: 200px;">
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó...</option>
          </select>
          <input type="email" id="clientEmail" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô client@company.com)" style="flex: 1; min-width: 250px;">
          <input type="password" id="clientPassword" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 6 ‡∏ï‡∏±‡∏ß)" style="flex: 1; min-width: 200px;" inputmode="numeric" pattern="[0-9]*" minlength="6">
          <button class="btn btn-primary" id="btnCreateClient">
            <span>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span>
            <span>+</span>
          </button>
        </div>
        <div style="margin-top: 12px; padding: 12px; background: rgba(5, 150, 105, 0.1); border-radius: 8px; font-size: 13px; color: #047857;">
          üí° <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Å‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö Read-only
        </div>
        <div id="clientMsg"></div>
      </div>

      <!-- Add Company Section -->
      <div class="add-section">
        <div class="add-section-title">
          <span>üè¢</span>
          <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÉ‡∏´‡∏°‡πà</span>
        </div>
        <div class="form-row">
          <input type="text" id="companyName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó (‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏™‡∏¢‡∏≤‡∏° ‡∏à‡∏≥‡∏Å‡∏±‡∏î)">
          <input type="text" id="companyCode" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó (‡πÄ‡∏ä‡πà‡∏ô AGR001)" style="width: 200px;">
          <button class="btn btn-primary" id="btnAddCompany">
            <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</span>
            <span>+</span>
          </button>
        </div>
      </div>

      <!-- Search -->
      <div class="search-bar">
        <span class="search-icon">üîç</span>
        <input type="text" class="search-input" id="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó, ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Å‡∏ï‡πå, ‡∏£‡∏´‡∏±‡∏™...">
      </div>

      <!-- Companies List -->
      <div id="companiesList"></div>

      <!-- Selected Project Detail -->
      <div class="detail-panel" id="detailPanel">
        <div class="detail-header">
          <div class="detail-title" id="detailTitle">‚Äî</div>
          <div class="detail-meta" id="detailMeta"></div>
        </div>

        <!-- Update Status -->
        <div class="section">
          <div class="section-title">
            <div class="section-icon">üìä</div>
            <span>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Å‡∏ï‡πå</span>
          </div>
          <div class="form-row">
            <select id="updStatus" style="flex: 1;">
              <option value="waiting_docs">‡∏£‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</option>
              <option value="precheck">‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</option>
              <option value="submitted">‡∏¢‡∏∑‡πà‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</option>
              <option value="pending_result">‡∏£‡∏≠‡∏ú‡∏•</option>
              <option value="done">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
              <option value="rejected">‡∏ñ‡∏π‡∏Å‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö</option>
            </select>
            <button class="btn btn-secondary" id="btnUpdateStatus">
              <span>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span>
              <span>‚úì</span>
            </button>
          </div>
        </div>

        <!-- Timeline -->
        <div class="section">
          <div class="section-title">
            <div class="section-icon">‚è±Ô∏è</div>
            <span>‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
          </div>
          <div class="form-row">
            <input type="text" id="tlStep" placeholder="‡πÄ‡∏ä‡πà‡∏ô '‡∏¢‡∏∑‡πà‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ‡∏≠‡∏¢. ‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö 012/68'" style="flex: 1;">
            <button class="btn btn-secondary" id="btnAddTimeline">
              <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå</span>
              <span>+</span>
            </button>
          </div>
          <div class="form-row">
            <textarea id="tlNote" rows="2" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>
          </div>
          <div class="timeline" id="timeline"></div>
        </div>

        <!-- Messages -->
        <div class="section">
          <div class="section-title">
            <div class="section-icon">üí¨</div>
            <span>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏∂‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span>
          </div>
          <div class="form-row">
            <textarea id="msgBody" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô '‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö'"></textarea>
          </div>
          <div class="form-row">
            <button class="btn btn-secondary" id="btnAddMsg">
              <span>‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</span>
              <span>üì§</span>
            </button>
          </div>
          <div class="message-list" id="messages"></div>
        </div>

        <!-- Documents -->
        <div class="section">
          <div class="section-title">
            <div class="section-icon">üìé</div>
            <span>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö</span>
          </div>
          <div class="form-row">
            <input type="file" id="docFile">
            <input type="text" id="docLabel" placeholder="‡∏õ‡πâ‡∏≤‡∏¢‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå (‡πÄ‡∏ä‡πà‡∏ô '‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£')">
            <button class="btn btn-secondary" id="btnUpload">
              <span>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</span>
              <span>üì§</span>
            </button>
          </div>
          <div class="doc-list" id="docs"></div>
        </div>

        <!-- Product Items -->
        <div class="section">
          <div class="section-title">
            <div class="section-icon">üì¶</div>
            <span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå/‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</span>
          </div>
          
          <!-- Search and Filter -->
          <div style="background: var(--bg-main); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <div style="position: relative; margin-bottom: 16px;">
              <span style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); font-size: 18px; color: var(--text-secondary);">üîç</span>
              <input 
                type="text" 
                id="itSearch" 
                placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤, ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç, ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô, ‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö..." 
                style="width: 100%; padding: 12px 16px 12px 48px; border: 2px solid var(--border); border-radius: 10px; font-size: 15px; margin: 0;"
              >
            </div>
            
            <div class="form-row" style="margin: 0;">
              <select id="itFilterStatus" style="margin: 0; flex: 1; min-width: 180px;">
                <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                <option value="waiting_docs">‡∏£‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</option>
                <option value="precheck">‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</option>
                <option value="submitted">‡∏¢‡∏∑‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß</option>
                <option value="pending_result">‡∏£‡∏≠‡∏ú‡∏•</option>
                <option value="done">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
                <option value="rejected">‡∏ñ‡∏π‡∏Å‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö</option>
              </select>
              <label class="checkbox-label">
                <input type="checkbox" id="itOnlyBlocker">
                <span>‚ö†Ô∏è ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤</span>
              </label>
            </div>
          </div>

          <!-- Add New Product -->
          <div style="background: linear-gradient(135deg, rgba(5, 150, 105, 0.05), rgba(52, 211, 153, 0.05)); border: 2px dashed var(--primary); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
            <div style="font-weight: 600; margin-bottom: 12px; color: var(--primary);">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</div>
            <div class="form-row">
              <input type="text" id="itTrade" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤ *" style="flex: 1; min-width: 200px;">
              <input type="text" id="itCommon" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç *" style="flex: 1; min-width: 200px;">
              <input type="text" id="itReg" placeholder="‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô" style="width: 150px;">
              <input type="text" id="itReceipt" placeholder="‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö" style="width: 150px;">
              <select id="itStep" style="width: 180px;">
                <option value="waiting_docs">‡∏£‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</option>
                <option value="precheck">‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</option>
                <option value="submitted">‡∏¢‡∏∑‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß</option>
                <option value="pending_result">‡∏£‡∏≠‡∏ú‡∏•</option>
                <option value="done">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
                <option value="rejected">‡∏ñ‡∏π‡∏Å‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö</option>
              </select>
              <button class="btn btn-primary" id="btnAddItem">
                <span>‡πÄ‡∏û‡∏¥‡πà‡∏°</span>
                <span>+</span>
              </button>
            </div>
          </div>

          <div id="items"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* Config */
const SUPABASE_URL = 'https://jlrogimfjmtwdqiuyejj.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impscm9naW1mam10d2RxaXV5ZWpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NDIyODUsImV4cCI6MjA3NTUxODI4NX0.OvX7qgcIF5aCcLebUEUR_6D2KTUP2pALCjRtHWJ5qZg';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* State */
let selectedProject = null;
let currentUser = null;
let currentRole = null;

/* Helpers */
const el = id => document.getElementById(id);
const esc = s => (s ?? '').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');

function showPage(pageId) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  el(pageId).classList.add('active');
}

function showMsg(id, text, type = '') {
  const n = el(id);
  if (!n) return;
  n.innerHTML = text ? `<div class="alert alert-${type || 'info'}">${text}</div>` : '';
}

function getStatusText(status) {
  const map = {
    waiting_docs: '‡∏£‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£',
    precheck: '‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô',
    submitted: '‡∏¢‡∏∑‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
    pending_result: '‡∏£‡∏≠‡∏ú‡∏•',
    done: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
    rejected: '‡∏ñ‡∏π‡∏Å‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö'
  };
  return map[status] || status;
}

/* Auth */
async function signIn() {
  const email = el('email').value.trim();
  const password = el('password').value;
  if (!email || !password) { showMsg('authMsg', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', 'error'); return; }
  const btn = el('btnSignIn'); btn.disabled = true; btn.innerHTML = '<span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...</span>';
  try {
    const { error } = await sb.auth.signInWithPassword({ email, password });
    if (error) throw error;
    showMsg('authMsg', '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...', 'success');
  } catch (e) {
    showMsg('authMsg', '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.message, 'error');
    btn.disabled = false; btn.innerHTML = '<span>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span><span>‚Üí</span>';
  }
}

async function signOut() {
  await sb.auth.signOut();
  sessionStorage.removeItem('adminPinOk');
  location.reload();
}

/* PIN */
async function ensureAdminPin() {
  if (sessionStorage.getItem('adminPinOk') === '1') return true;
  el('pinModal').classList.add('show');
  return false;
}

async function verifyPin() {
  const pin = el('adminPin').value;
  if (!pin) { showMsg('pinMsg', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà PIN', 'error'); return; }
  try {
    const { data, error } = await sb.rpc('verify_admin_pin', { p_pin: pin });
    if (error) throw error;
    if (!data) { showMsg('pinMsg', 'PIN ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error'); return; }
    sessionStorage.setItem('adminPinOk', '1');
    el('pinModal').classList.remove('show');
    showMsg('pinMsg', '');
    showPage('appPage');
    await loadAllCompanies();
    await loadCompaniesDropdown();
  } catch (e) {
    showMsg('pinMsg', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message, 'error');
  }
}

async function setPin() {
  const newPin = prompt('‡∏ï‡∏±‡πâ‡∏á/‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Admin PIN (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏´‡∏•‡∏±‡∏Å):');
  if (!newPin) return;
  if (newPin.length < 6) { alert('PIN ‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏´‡∏•‡∏±‡∏Å'); return; }
  try {
    const { error } = await sb.rpc('set_admin_pin', { p_pin: newPin });
    if (error) throw error;
    alert('‡∏ï‡∏±‡πâ‡∏á/‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô PIN ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úì');
  } catch (e) {
    alert('‡∏ï‡∏±‡πâ‡∏á PIN ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.message);
  }
}

/* Auth Guard */
async function guardAdminStaff() {
  const { data: s } = await sb.auth.getSession();
  if (!s.session) { showPage('loginPage'); return false; }
  const uid = s.session.user.id; currentUser = s.session.user;
  const { data, error } = await sb.from('memberships').select('role').eq('user_id', uid).limit(1);
  if (error || !data || data.length === 0) { showMsg('authMsg','‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô','error'); showPage('loginPage'); return false; }
  currentRole = data[0].role;
  if (!(currentRole === 'admin' || currentRole === 'staff')) { showMsg('authMsg','‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô','error'); showPage('loginPage'); return false; }
  updateUserInfo();
  const okPin = await ensureAdminPin();
  if (okPin) { showPage('appPage'); await loadCompaniesDropdown(); }
  return okPin;
}

function updateUserInfo() {
  if (!currentUser) return;
  el('whoEmail').textContent = 'üë§ ' + (currentUser.email || '‚Äî');
  el('whoRole').textContent = 'üé≠ ' + (currentRole || '‚Äî');
}

/* Companies & Projects */
async function loadAllCompanies() {
  const query = el('search').value?.trim()?.toLowerCase() || '';
  let { data: companies, error: cError } = await sb.from('companies').select('id, name, code').order('name');
  if (cError) { console.error('Load companies error:', cError); return; }
  let { data: projects, error: pError } = await sb.from('projects').select('id, title, status, due_date, company_id').order('created_at', { ascending: false });
  if (pError) { console.error('Load projects error:', pError); return; }

  if (query) {
    companies = companies.filter(c => (c.name||'').toLowerCase().includes(query) || (c.code||'').toLowerCase().includes(query));
    projects = projects.filter(p => (p.title||'').toLowerCase().includes(query));
  }

  const projectsByCompany = {};
  projects.forEach(p => { (projectsByCompany[p.company_id] ||= []).push(p); });

  const list = el('companiesList'); list.innerHTML = '';
  if (companies.length === 0) {
    list.innerHTML = `<div class="empty-state"><div class="empty-icon">üè¢</div><div class="empty-text">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö<br>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</div></div>`;
    return;
  }

  companies.forEach(company => {
    const companyProjects = projectsByCompany[company.id] || [];
    const stats = {
      total: companyProjects.length,
      done: companyProjects.filter(p => p.status === 'done').length,
      inProgress: companyProjects.filter(p => !['done','rejected'].includes(p.status)).length,
      rejected: companyProjects.filter(p => p.status === 'rejected').length
    };
    const section = document.createElement('div');
    section.className = 'company-section';
    section.innerHTML = `
      <div class="company-header">
        <div class="company-title">
          <div class="company-icon">${company.name.charAt(0)}</div>
          <div class="company-info">
            <h2>${esc(company.name)}</h2>
            <div class="company-code">‡∏£‡∏´‡∏±‡∏™: ${esc(company.code)}</div>
          </div>
        </div>
        <div class="company-meta">
          <div class="company-stats">
            <div class="stat-item"><span class="stat-label">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span><span class="stat-value">${stats.total}</span></div>
            <div class="stat-item"><span class="stat-label">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£:</span><span class="stat-value">${stats.inProgress}</span></div>
            <div class="stat-item"><span class="stat-label">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô:</span><span class="stat-value">${stats.done}</span></div>
          </div>
          <button class="btn btn-primary" onclick="addProjectToCompany('${company.id}', '${esc(company.name)}')"><span>+ ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Å‡∏ï‡πå</span></button>
        </div>
      </div>
      <div class="projects-grid" id="projects_${company.id}"></div>
    `;
    list.appendChild(section);

    const grid = el(`projects_${company.id}`);
    if (companyProjects.length === 0) {
      grid.innerHTML = `<div class="empty-state" style="grid-column: 1/-1; padding: 40px;"><div class="empty-icon">üìã</div><div class="empty-text">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Å‡∏ï‡πå</div></div>`;
    } else {
      companyProjects.forEach(project => {
        const card = document.createElement('div');
        card.className = 'project-card';
        if (selectedProject && selectedProject.id === project.id) card.classList.add('selected');
        card.innerHTML = `
          <div class="project-header">
            <div class="project-title">${esc(project.title)}</div>
            <div class="status-badge status-${project.status}">${getStatusText(project.status)}</div>
          </div>
          <div class="project-meta">
            <div class="meta-item">üìÖ ${project.due_date || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
          </div>
        `;
        card.onclick = () => selectProject({...project, company_name: company.name});
        grid.appendChild(card);
      });
    }
  });
}

function addProjectToCompany(companyId, companyName) {
  const title = prompt(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Å‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${companyName}\n\n‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Å‡∏ï‡πå:`);
  if (!title) return;
  sb.from('projects').insert({ company_id: companyId, title: title.trim(), status: 'waiting_docs' }).select()
    .then(({ error }) => { if (error) { alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Å‡∏ï‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message); return; } loadAllCompanies(); });
}

async function addCompany() {
  const name = el('companyName').value.trim();
  const code = el('companyCode').value.trim();
  if (!name || !code) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó'); return; }
  const { error } = await sb.from('companies').insert({ name, code });
  if (error) { alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message); return; }
  el('companyName').value = ''; el('companyCode').value = '';
  await loadAllCompanies(); await loadCompaniesDropdown();
}

/* Client Management */
async function loadCompaniesDropdown() {
  const { data, error } = await sb.from('companies').select('id, name, code').order('name');
  if (error) return;
  const select = el('clientCompanyId'); const currentValue = select.value;
  select.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó...</option>' + (data||[]).map(c => `<option value="${c.id}">${esc(c.name)} (${esc(c.code)})</option>`).join('');
  if (currentValue) select.value = currentValue;
}

async function createClient() {
  const companyId = el('clientCompanyId').value;
  const email = el('clientEmail').value.trim();
  const password = el('clientPassword').value;
  if (!companyId) { showMsg('clientMsg','‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó','error'); return; }
  if (!email) { showMsg('clientMsg','‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•','error'); return; }
  if (!password || password.length < 6) { showMsg('clientMsg','‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£','error'); return; }

  const btn = el('btnCreateClient'); btn.disabled = true; btn.innerHTML = '<span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ...</span>';
  try {
    const { error } = await sb.rpc('create_client_account', { p_email: email, p_password: password, p_company_id: companyId });
    if (error) throw error;
    showMsg('clientMsg', `‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!<br>‡∏≠‡∏µ‡πÄ‡∏°‡∏•: ${email}<br>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô: ${password}<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤`, 'success');
    el('clientCompanyId').value = ''; el('clientEmail').value = ''; el('clientPassword').value = '';
  } catch (e) {
    showMsg('clientMsg', '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.message, 'error');
  } finally {
    btn.disabled = false; btn.innerHTML = '<span>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span><span>+</span>';
  }
}

async function selectProject(project) {
  selectedProject = project;
  document.querySelectorAll('.project-card').forEach(c => c.classList.remove('selected'));
  // best-effort highlight
  const cards = Array.from(document.querySelectorAll('.project-card'));
  const card = cards.find(k => k.querySelector('.project-title')?.textContent === project.title);
  if (card) card.classList.add('selected');

  el('detailPanel').classList.add('show');
  el('detailPanel').scrollIntoView({ behavior: 'smooth', block: 'start' });
  el('detailTitle').textContent = project.title;
  el('detailMeta').innerHTML = `
    <span class="badge badge-user">${esc(project.company_name)}</span>
    <span class="status-badge status-${project.status}">${getStatusText(project.status)}</span>
    <span class="badge" style="background:#e0e7ff; color:#4338ca;">üìÖ ${project.due_date || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>
  `;
  el('updStatus').value = project.status;
  await loadTimeline(); await loadMessages(); await loadDocs(); await loadItems();
}

async function updateStatus() {
  if (!selectedProject) return;
  const status = el('updStatus').value;
  const { error } = await sb.from('projects').update({ status }).eq('id', selectedProject.id);
  if (error) { alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message); return; }
  selectedProject.status = status;
  await sb.from('timeline').insert({ project_id: selectedProject.id, step: `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${getStatusText(status)}` });
  await loadAllCompanies(); await loadTimeline();
}

/* Timeline */
async function addTimeline() {
  if (!selectedProject) return;
  const step = el('tlStep').value.trim();
  const note = el('tlNote').value.trim() || null;
  if (!step) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô'); return; }
  const { error } = await sb.from('timeline').insert({ project_id: selectedProject.id, step, note });
  if (error) { alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message); return; }
  el('tlStep').value = ''; el('tlNote').value = ''; await loadTimeline();
}

async function loadTimeline() {
  if (!selectedProject) return;
  const { data, error } = await sb.from('timeline').select('*').eq('project_id', selectedProject.id).order('created_at', { ascending: false });
  if (error) return;
  const container = el('timeline');
  if (!data || data.length === 0) { container.innerHTML = '<div class="empty-state"><div class="empty-text">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå</div></div>'; return; }
  container.innerHTML = data.map(t => `
    <div class="timeline-item">
      <div class="timeline-step">${esc(t.step)}</div>
      ${t.note ? `<div class="timeline-note">${esc(t.note)}</div>` : ''}
      <div class="timeline-date">${new Date(t.created_at).toLocaleString('th-TH')}</div>
    </div>
  `).join('');
}

/* Messages */
async function addMsg() {
  if (!selectedProject) return;
  const body = el('msgBody').value.trim();
  if (!body) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°'); return; }
  const { error } = await sb.from('messages').insert({ project_id: selectedProject.id, body, by_role: 'staff' });
  if (error) { alert('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message); return; }
  el('msgBody').value = ''; await loadMessages();
}

async function loadMessages() {
  if (!selectedProject) return;
  const { data, error } = await sb.from('messages').select('*').eq('project_id', selectedProject.id).order('created_at', { ascending: false });
  if (error) return;
  const container = el('messages');
  if (!data || data.length === 0) { container.innerHTML = '<div class="empty-state"><div class="empty-text">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</div></div>'; return; }
  container.innerHTML = data.map(m => `
    <div class="message-item">
      <div class="message-header">
        <div class="message-role">${m.by_role === 'staff' ? 'üë§ ‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô' : 'üë• ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤'}</div>
        <div class="message-date">${new Date(m.created_at).toLocaleString('th-TH')}</div>
      </div>
      <div class="message-body">${esc(m.body)}</div>
    </div>
  `).join('');
}

/* Documents */
async function uploadDoc() {
  if (!selectedProject) return;
  const file = el('docFile').files[0];
  if (!file) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå'); return; }
  const label = el('docLabel').value.trim() || file.name;
  const path = `${selectedProject.id}/${Date.now()}_${file.name}`;
  const { error: uploadError } = await sb.storage.from('docs').upload(path, file);
  if (uploadError) { alert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + uploadError.message); return; }
  const { error: dbError } = await sb.from('documents').insert({ project_id: selectedProject.id, file_path: path, label });
  if (dbError) { alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + dbError.message); return; }
  el('docFile').value = ''; el('docLabel').value = ''; await loadDocs();
}

async function loadDocs() {
  if (!selectedProject) return;
  const { data, error } = await sb.from('documents').select('*').eq('project_id', selectedProject.id).order('created_at', { ascending: false });
  if (error) return;
  const container = el('docs');
  if (!data || data.length === 0) { container.innerHTML = '<div class="empty-state"><div class="empty-text">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</div></div>'; return; }
  const html = await Promise.all(data.map(async doc => {
    const { data: signed } = await sb.storage.from('docs').createSignedUrl(doc.file_path, 600);
    return `
      <div class="doc-item">
        <div class="doc-label">üìÑ ${esc(doc.label)}</div>
        <div class="doc-date">${new Date(doc.created_at).toLocaleString('th-TH')}</div>
        <a href="${signed?.signedUrl || '#'}" target="_blank" class="btn btn-outline" style="width:100%;">‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå ‚Üí</a>
      </div>
    `;
  }));
  container.innerHTML = html.join('');
}

/* Product Items */
async function addItem() {
  if (!selectedProject) return;
  const tradeName = el('itTrade').value.trim();
  const commonName = el('itCommon').value.trim();
  if (!tradeName) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤'); return; }
  if (!commonName) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç'); return; }
  const payload = {
    project_id: selectedProject.id,
    trade_name: tradeName,
    common_name: commonName,
    reg_no: el('itReg').value.trim() || null,
    receipt_no: el('itReceipt').value.trim() || null,
    status_step: el('itStep').value
  };
  const { error } = await sb.from('product_items').insert(payload);
  if (error) { alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message); return; }
  ['itTrade','itCommon','itReg','itReceipt'].forEach(id => el(id).value = '');
  await loadItems();
}

async function saveItem(id) {
  const payload = {
    trade_name: el(`t_${id}`).value.trim() || null,
    common_name: el(`c_${id}`).value.trim() || null,
    reg_no: el(`r_${id}`).value.trim() || null,
    receipt_no: el(`rc_${id}`).value.trim() || null,
    status_step: el(`s_${id}`).value,
    submitted_at: el(`sub_${id}`).value || null,
    admin_note: el(`an_${id}`).value.trim() || null,
    client_note: el(`cn_${id}`).value.trim() || null,
    blocker: el(`b_${id}`).checked,
    blocker_note: el(`bn_${id}`).value.trim() || null
  };
  const { error } = await sb.from('product_items').update(payload).eq('id', id);
  if (error) { alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message); return; }
  await loadItems();
}

async function delItem(id) {
  if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
  const { error } = await sb.from('product_items').delete().eq('id', id);
  if (error) { alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message); return; }
  await loadItems();
}

async function loadItems() {
  if (!selectedProject) return;
  const keyword = el('itSearch').value.trim().toLowerCase();
  const status = el('itFilterStatus').value;
  const onlyBlocker = el('itOnlyBlocker').checked;
  let { data, error } = await sb.from('product_items').select('*').eq('project_id', selectedProject.id).order('created_at', { ascending: false });
  if (error) return;

  if (keyword) {
    data = data.filter(x => {
      const text = [x.trade_name,x.common_name,x.reg_no,x.receipt_no,x.admin_note,x.client_note]
        .filter(Boolean).join(' ').toLowerCase();
      return text.includes(keyword);
    });
  }
  if (status) data = data.filter(x => x.status_step === status);
  if (onlyBlocker) data = data.filter(x => x.blocker);

  const container = el('items');
  if (!data || data.length === 0) {
    container.innerHTML = (keyword || status || onlyBlocker)
      ? '<div class="empty-state"><div class="empty-text">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div></div>'
      : '<div class="empty-state"><div class="empty-text">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå<br>‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</div></div>';
    return;
  }

  container.innerHTML = data.map(item => `
    <div class="product-item">
      <div class="product-header">
        <div class="product-names" style="flex:1;">
          <div class="field-label">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤</div>
          <input id="t_${item.id}" value="${esc(item.trade_name || '')}" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤ *" style="font-size:16px; font-weight:600; margin-bottom:12px;">
          <div class="field-label">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç</div>
          <input id="c_${item.id}" value="${esc(item.common_name || '')}" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç *" style="font-size:15px;">
        </div>
        ${item.blocker ? '<div class="blocker-badge">‚ö†Ô∏è ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤</div>' : ''}
      </div>

      <div class="product-fields">
        <div class="field-group">
          <div class="field-label">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</div>
          <input id="r_${item.id}" value="${esc(item.reg_no || '')}">
        </div>
        <div class="field-group">
          <div class="field-label">‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö</div>
          <input id="rc_${item.id}" value="${esc(item.receipt_no || '')}">
        </div>
        <div class="field-group">
          <div class="field-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
          <select id="s_${item.id}">
            <option value="waiting_docs" ${item.status_step==='waiting_docs'?'selected':''}>‡∏£‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</option>
            <option value="precheck" ${item.status_step==='precheck'?'selected':''}>‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</option>
            <option value="submitted" ${item.status_step==='submitted'?'selected':''}>‡∏¢‡∏∑‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß</option>
            <option value="pending_result" ${item.status_step==='pending_result'?'selected':''}>‡∏£‡∏≠‡∏ú‡∏•</option>
            <option value="done" ${item.status_step==='done'?'selected':''}>‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
            <option value="rejected" ${item.status_step==='rejected'?'selected':''}>‡∏ñ‡∏π‡∏Å‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö</option>
          </select>
        </div>
        <div class="field-group">
          <div class="field-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡πà‡∏ô</div>
          <input type="date" id="sub_${item.id}" value="${item.submitted_at || ''}">
        </div>
      </div>

      <div class="product-fields">
        <div class="field-group">
          <div class="field-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏†‡∏≤‡∏¢‡πÉ‡∏ô</div>
          <input id="an_${item.id}" value="${esc(item.admin_note || '')}" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô">
        </div>
        <div class="field-group">
          <div class="field-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
          <input id="cn_${item.id}" value="${esc(item.client_note || '')}" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô">
        </div>
      </div>

      <div class="form-row">
        <label class="checkbox-label">
          <input type="checkbox" id="b_${item.id}" ${item.blocker ? 'checked' : ''}>
          <span>‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (Blocker)</span>
        </label>
        <input id="bn_${item.id}" value="${esc(item.blocker_note || '')}" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤" style="flex:1; margin:0;">
      </div>

      <div class="product-actions">
        <button class="btn btn-secondary" onclick="saveItem('${item.id}')"><span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span><span>üíæ</span></button>
        <button class="btn btn-danger" onclick="delItem('${item.id}')"><span>‡∏•‡∏ö</span><span>üóëÔ∏è</span></button>
      </div>
    </div>
  `).join('');
}

/* Init */
document.addEventListener('DOMContentLoaded', async () => {
  el('btnSignIn').onclick = signIn;
  el('btnSignOut2').onclick = signOut;
  el('btnVerifyPin').onclick = verifyPin;
  el('btnSetPin').onclick = setPin;

  el('btnAddCompany').onclick = addCompany;
  el('btnCreateClient').onclick = createClient;
  el('btnUpdateStatus').onclick = updateStatus;
  el('btnAddTimeline').onclick = addTimeline;
  el('btnAddMsg').onclick = addMsg;
  el('btnUpload').onclick = uploadDoc;
  el('btnAddItem').onclick = addItem;

  el('search').oninput = loadAllCompanies;

  // Product search with debounce
  let itemSearchTimeout;
  el('itSearch').oninput = () => {
    clearTimeout(itemSearchTimeout);
    itemSearchTimeout = setTimeout(() => { if (selectedProject) loadItems(); }, 300);
  };
  el('itFilterStatus').onchange = loadItems;
  el('itOnlyBlocker').onchange = loadItems;

  // Enter key shortcuts
  el('email').addEventListener('keydown', e => (e.key === 'Enter') && signIn());
  el('password').addEventListener('keydown', e => (e.key === 'Enter') && signIn());
  el('adminPin').addEventListener('keydown', e => (e.key === 'Enter') && verifyPin());

  sb.auth.onAuthStateChange(async () => { await guardAdminStaff(); });
  await guardAdminStaff();

  sb.channel('realtime')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'projects' }, () => { loadAllCompanies(); })
    .on('postgres_changes', { event: '*', schema: 'public', table: 'timeline' }, () => { if (selectedProject) loadTimeline(); })
    .on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, () => { if (selectedProject) loadMessages(); })
    .on('postgres_changes', { event: '*', schema: 'public', table: 'documents' }, () => { if (selectedProject) loadDocs(); })
    .on('postgres_changes', { event: '*', schema: 'public', table: 'product_items' }, () => { if (selectedProject) loadItems(); })
    .subscribe();
});
</script>

</body>
</html>
