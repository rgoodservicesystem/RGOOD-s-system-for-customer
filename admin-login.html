<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>เข้าสู่ระบบทีมงาน — R. GOOD Service</title>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">
<!-- ใช้ UMD build เพื่อให้ window.supabase ใช้งานได้แน่นอน -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<style>
  :root{ --bg:#0f172a; --card:#0e1628; --ink:#e5e7eb; --muted:#94a3b8; --border:#1f2937; --accent:#22d3ee; }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b1224,#0f172a);color:var(--ink);font-family:'Prompt',system-ui;}
  .wrap{max-width:480px;margin:8vh auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:22px;box-shadow:0 10px 24px rgba(0,0,0,.25)}
  h1{font-size:22px;margin:0 0 6px 0;text-align:center}
  .muted{color:var(--muted);font-size:13px;text-align:center}
  .row{display:grid;gap:10px;margin-top:14px}
  label{font-size:13px;color:var(--muted)}
  input{width:100%;background:#071326;color:var(--ink);border:1px solid var(--border);border-radius:12px;padding:12px 14px}
  .btn{background:var(--accent);color:#05222b;border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .foot{margin-top:12px;display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:13px}
  .err{color:#ef4444}
  .ok{color:#10b981}
  .center{display:flex;justify-content:center;margin-top:12px}
  a{color:#8be9ff;text-decoration:none}
  a:hover{text-decoration:underline}
  .brand{display:flex;flex-direction:column;align-items:center;margin-bottom:14px}
  .brand img{width:96px;height:auto;border-radius:12px;box-shadow:0 0 20px rgba(255,255,255,.12)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="brand">
      <img src="https://i.ibb.co/J1KDprF/image.jpg" alt="R. Good Service Logo">
      <h1>เข้าสู่ระบบทีมงาน</h1>
      <div class="muted">เฉพาะผู้มีสิทธิ์: Admin / Staff</div>
    </div>

    <div class="row">
      <label>อีเมล</label>
      <input id="email" placeholder="name@company.com">
    </div>
    <div class="row">
      <label>รหัสผ่าน</label>
      <input id="password" type="password" placeholder="••••••••">
    </div>
    <div class="row">
      <label class="muted" style="display:flex;align-items:center;gap:8px">
        <input id="remember" type="checkbox" style="accent-color:#22d3ee"> จำอีเมลไว้ในเครื่องนี้
      </label>
    </div>
    <div class="row">
      <button class="btn" id="btnLogin">เข้าสู่ระบบ</button>
      <div id="msg" class="muted"></div>
    </div>

    <div class="foot">
      <span>ลืมรหัสผ่าน? <a href="#" id="resetLink">ส่งลิงก์รีเซ็ตรหัส</a></span>
      <a href="index.html">กลับหน้าหลัก</a>
    </div>
  </div>

  <div class="center muted">© <span id="yy"></span> R. GOOD SERVICE REGISTRATION</div>
</div>

<script>
(() => {
  // === ตั้งค่าของคุณ (ใช้ของโปรเจกต์คุณที่ให้มา) ===
  const SUPABASE_URL = 'https://jlrogimfjmtwdqiuyejj.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impscm9naW1mam10d2RxaXV5ZWpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NDIyODUsImV4cCI6MjA3NTUxODI4NX0.OvX7qgcIF5aCcLebUEUR_6D2KTUP2pALCjRtHWJ5qZg';
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const el = id => document.getElementById(id);
  const msg = (html, cls='') => { const n = el('msg'); n.className = 'muted ' + (cls||''); n.innerHTML = html; };

  // เติมปี
  el('yy').textContent = new Date().getFullYear();

  // จำอีเมล
  const savedEmail = localStorage.getItem('ADMIN_EMAIL') || '';
  if(savedEmail){ el('email').value = savedEmail; el('remember').checked = true; }

  // เมื่อมี session อยู่แล้ว → ตรวจ role แล้วเด้งไป admin.html เลย
  sb.auth.getSession().then(async ({ data }) => {
    if (data.session) {
      await enforceRoleAndGo();
    }
  });

  // login
  el('btnLogin').onclick = async () => {
    const email = el('email').value.trim();
    const password = el('password').value;
    if(!email || !password){ msg('<span class="err">กรอกอีเมลและรหัสผ่านให้ครบ</span>'); return; }

    el('btnLogin').disabled = true;
    msg('กำลังเข้าสู่ระบบ…');

    try{
      const { error } = await sb.auth.signInWithPassword({ email, password });
      if(error){ msg('<span class="err">เข้าสู่ระบบไม่สำเร็จ: '+error.message+'</span>'); el('btnLogin').disabled = false; return; }

      // จำอีเมลถ้าติ๊กไว้
      if(el('remember').checked) localStorage.setItem('ADMIN_EMAIL', email);
      else localStorage.removeItem('ADMIN_EMAIL');

      // ตรวจ role แล้วค่อยเข้า
      await enforceRoleAndGo();
    }catch(e){
      msg('<span class="err">ผิดพลาด: '+(e.message||e)+'</span>');
      el('btnLogin').disabled = false;
    }
  };

  // Reset password link
  el('resetLink').onclick = async (e) => {
    e.preventDefault();
    const email = (el('email').value||'').trim();
    if(!email){ msg('<span class="err">กรอกอีเมลก่อน</span>'); return; }
    try{
      const { error } = await sb.auth.resetPasswordForEmail(email, {
        redirectTo: location.origin + '/admin-login.html'
      });
      if(error) throw error;
      msg('<span class="ok">ส่งลิงก์รีเซ็ตรหัสแล้ว โปรดตรวจอีเมล</span>');
    }catch(err){
      msg('<span class="err">ส่งลิงก์ไม่สำเร็จ: '+(err.message||err)+'</span>');
    }
  };

  // บังคับตรวจ role จาก public.profiles (id = auth.user.id)
  async function enforceRoleAndGo(){
    try{
      const { data: s } = await sb.auth.getSession();
      if(!s || !s.session){ msg('<span class="err">ยังไม่ได้ล็อกอิน</span>'); el('btnLogin').disabled = false; return; }
      const uid = s.session.user.id;

      // พยายามอ่านโปรไฟล์
      let { data: prof, error } = await sb.from('profiles').select('id,role,display_name').eq('id', uid).maybeSingle();

      // ถ้ายังไม่มีโปรไฟล์ สร้างให้ (default: staff)
      if(error && error.code === 'PGRST116'){ prof = null; } // not found
      if(!prof){
        const up = { id: uid, role: 'staff', display_name: s.session.user.email || 'staff' };
        const { error: e2 } = await sb.from('profiles').upsert(up).select().maybeSingle();
        if(e2){ msg('<span class="err">สร้างโปรไฟล์ไม่ได้: '+e2.message+'</span>'); el('btnLogin').disabled = false; return; }
        prof = up;
      }

      const role = (prof.role || '').toLowerCase();
      if(role !== 'admin' && role !== 'staff'){
        // ไม่อนุญาต → ออกจากระบบ
        await sb.auth.signOut();
        msg('<span class="err">บัญชีนี้ไม่มีสิทธิ์เข้าหน้าแอดมิน (role = '+(prof.role||'-')+')</span>');
        el('btnLogin').disabled = false;
        return;
      }

      // ผ่าน → ไปหน้าแอดมิน
      msg('<span class="ok">ตรวจสิทธิ์สำเร็จ ('+role+') → กำลังเข้าแดชบอร์ด…</span>');
      location.href = 'admin.html';
    }catch(e){
      msg('<span class="err">ตรวจสิทธิ์ไม่สำเร็จ: '+(e.message||e)+'</span>');
      el('btnLogin').disabled = false;
    }
  }
})();
</script>
</body>
</html>
