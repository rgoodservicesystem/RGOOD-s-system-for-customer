<!DOCTYPE html>

<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Å‡∏ï‡πå - ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (client.html)</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #059669;
  --primary-dark: #047857;
  --secondary: #3b82f6;
  --bg-main: #f8fafc;
  --bg-card: #ffffff;
  --text-primary: #1e293b;
  --text-secondary: #64748b;
  --border: #e2e8f0;
  --shadow: 0 1px 3px rgba(0,0,0,0.1);
  --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
  --success: #10b981;
}

- { box-sizing: border-box; margin: 0; padding: 0; }

body {
font-family: ‚ÄòPrompt‚Äô, sans-serif;
background: var(‚Äìbg-main);
color: var(‚Äìtext-primary);
line-height: 1.6;
}

.page {
display: none;
animation: fadeIn 0.4s ease-in-out;
}

.page.active {
display: block;
}

@keyframes fadeIn {
from { opacity: 0; transform: translateY(20px); }
to { opacity: 1; transform: translateY(0); }
}

/* Login Page */
.login-page {
min-height: 100vh;
display: flex;
align-items: center;
justify-content: center;
background: linear-gradient(135deg, #0f766e 0%, #059669 50%, #34d399 100%);
padding: 20px;
position: relative;
overflow: hidden;
}

.login-page::before {
content: ‚Äò‚Äô;
position: absolute;
width: 500px;
height: 500px;
background: rgba(255,255,255,0.1);
border-radius: 50%;
top: -250px;
right: -250px;
}

.login-page::after {
content: ‚Äò‚Äô;
position: absolute;
width: 400px;
height: 400px;
background: rgba(255,255,255,0.05);
border-radius: 50%;
bottom: -200px;
left: -200px;
}

.login-container {
position: relative;
z-index: 1;
width: 100%;
max-width: 480px;
}

.login-card {
background: var(‚Äìbg-card);
padding: 48px 40px;
border-radius: 24px;
box-shadow: 0 20px 60px rgba(0,0,0,0.2);
}

.login-header {
text-align: center;
margin-bottom: 40px;
}

.login-icon {
width: 80px;
height: 80px;
background: linear-gradient(135deg, var(‚Äìprimary), #34d399);
border-radius: 20px;
display: flex;
align-items: center;
justify-content: center;
font-size: 40px;
margin: 0 auto 20px;
box-shadow: 0 10px 30px rgba(5, 150, 105, 0.3);
}

.login-title {
font-size: 28px;
font-weight: 700;
color: var(‚Äìtext-primary);
margin-bottom: 8px;
}

.login-subtitle {
color: var(‚Äìtext-secondary);
font-size: 15px;
}

.input-group {
margin-bottom: 24px;
}

.input-label {
display: block;
margin-bottom: 8px;
color: var(‚Äìtext-primary);
font-weight: 500;
font-size: 14px;
}

.input-wrapper {
position: relative;
}

.input-icon {
position: absolute;
left: 16px;
top: 50%;
transform: translateY(-50%);
color: var(‚Äìtext-secondary);
font-size: 18px;
}

.form-input {
width: 100%;
padding: 14px 16px 14px 48px;
border: 2px solid var(‚Äìborder);
border-radius: 12px;
font-size: 15px;
font-family: ‚ÄòPrompt‚Äô, sans-serif;
transition: all 0.3s;
background: var(‚Äìbg-main);
}

.form-input:focus {
outline: none;
border-color: var(‚Äìprimary);
background: white;
box-shadow: 0 0 0 4px rgba(5, 150, 105, 0.1);
}

.btn {
padding: 14px 24px;
border-radius: 12px;
border: none;
font-weight: 600;
cursor: pointer;
transition: all 0.3s;
font-family: ‚ÄòPrompt‚Äô, sans-serif;
font-size: 15px;
display: inline-flex;
align-items: center;
justify-content: center;
gap: 8px;
}

.btn-primary {
background: var(‚Äìprimary);
color: white;
width: 100%;
padding: 16px;
font-size: 16px;
}

.btn-primary:hover {
background: var(‚Äìprimary-dark);
transform: translateY(-2px);
box-shadow: 0 10px 30px rgba(5, 150, 105, 0.3);
}

.btn-primary:disabled {
opacity: 0.6;
cursor: not-allowed;
transform: none;
}

.btn-outline {
background: transparent;
border: 2px solid var(‚Äìborder);
color: var(‚Äìtext-primary);
}

.btn-outline:hover {
border-color: var(‚Äìprimary);
background: rgba(5, 150, 105, 0.05);
}

.alert {
margin-top: 20px;
padding: 14px 16px;
border-radius: 12px;
font-size: 14px;
text-align: center;
animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
from { opacity: 0; transform: translateY(-10px); }
to { opacity: 1; transform: translateY(0); }
}

.alert-error {
background: #fee;
color: #ef4444;
border: 1px solid #fcc;
}

.alert-success {
background: #efe;
color: var(‚Äìsuccess);
border: 1px solid #cfc;
}

/* Main App */
.app-page {
min-height: 100vh;
display: flex;
flex-direction: column;
}

.header {
background: var(‚Äìbg-card);
border-bottom: 1px solid var(‚Äìborder);
padding: 20px 24px;
box-shadow: var(‚Äìshadow);
position: sticky;
top: 0;
z-index: 100;
}

.header-content {
max-width: 1200px;
margin: 0 auto;
display: flex;
justify-content: space-between;
align-items: center;
gap: 20px;
flex-wrap: wrap;
}

.header-left {
display: flex;
align-items: center;
gap: 16px;
}

.header-logo {
width: 48px;
height: 48px;
background: linear-gradient(135deg, var(‚Äìprimary), #34d399);
border-radius: 12px;
display: flex;
align-items: center;
justify-content: center;
font-size: 24px;
box-shadow: 0 4px 12px rgba(5, 150, 105, 0.2);
}

.header-title {
font-size: 20px;
color: var(‚Äìprimary);
font-weight: 700;
}

.header-right {
display: flex;
gap: 12px;
align-items: center;
flex-wrap: wrap;
}

.badge {
display: inline-flex;
align-items: center;
gap: 6px;
padding: 8px 16px;
border-radius: 20px;
font-size: 13px;
font-weight: 500;
background: #e0f2fe;
color: #0369a1;
}

.container {
flex: 1;
max-width: 1200px;
margin: 0 auto;
padding: 32px 24px;
width: 100%;
}

.welcome-card {
background: linear-gradient(135deg, rgba(5, 150, 105, 0.1), rgba(52, 211, 153, 0.05));
border: 2px solid var(‚Äìprimary);
border-radius: 20px;
padding: 32px;
margin-bottom: 32px;
text-align: center;
}

.welcome-card h2 {
font-size: 28px;
color: var(‚Äìprimary);
margin-bottom: 12px;
}

.welcome-card p {
color: var(‚Äìtext-secondary);
font-size: 16px;
}

.projects-section {
margin-bottom: 32px;
}

.section-title {
font-size: 24px;
font-weight: 700;
color: var(‚Äìtext-primary);
margin-bottom: 20px;
display: flex;
align-items: center;
gap: 12px;
}

.projects-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
gap: 20px;
}

.project-card {
background: var(‚Äìbg-card);
border: 2px solid var(‚Äìborder);
border-radius: 16px;
padding: 24px;
cursor: pointer;
transition: all 0.3s;
position: relative;
overflow: hidden;
}

.project-card::before {
content: ‚Äò‚Äô;
position: absolute;
top: 0;
left: 0;
right: 0;
height: 4px;
background: linear-gradient(90deg, var(‚Äìprimary), #34d399);
transform: scaleX(0);
transition: transform 0.3s;
}

.project-card:hover {
transform: translateY(-8px);
box-shadow: 0 12px 32px rgba(0,0,0,0.12);
border-color: var(‚Äìprimary);
}

.project-card:hover::before {
transform: scaleX(1);
}

.project-card.selected {
border-color: var(‚Äìprimary);
background: linear-gradient(135deg, rgba(5, 150, 105, 0.05), rgba(52, 211, 153, 0.03));
box-shadow: 0 8px 24px rgba(5, 150, 105, 0.15);
}

.project-card.selected::before {
transform: scaleX(1);
}

.project-header {
display: flex;
justify-content: space-between;
align-items: start;
margin-bottom: 16px;
gap: 12px;
}

.project-title {
font-size: 18px;
font-weight: 600;
color: var(‚Äìtext-primary);
flex: 1;
line-height: 1.4;
}

.status-badge {
padding: 6px 14px;
border-radius: 12px;
font-size: 12px;
font-weight: 600;
white-space: nowrap;
}

.status-waiting_docs { background: #fef3c7; color: #92400e; }
.status-precheck { background: #dbeafe; color: #1e40af; }
.status-submitted { background: #e0e7ff; color: #4338ca; }
.status-pending_result { background: #fce7f3; color: #9f1239; }
.status-done { background: #d1fae5; color: #065f46; }
.status-rejected { background: #fee2e2; color: #991b1b; }

.project-meta {
display: flex;
gap: 16px;
color: var(‚Äìtext-secondary);
font-size: 13px;
}

.meta-item {
display: flex;
align-items: center;
gap: 6px;
}

/* Detail Panel */
.detail-panel {
background: var(‚Äìbg-card);
border-radius: 20px;
padding: 32px;
box-shadow: var(‚Äìshadow-lg);
border: 2px solid var(‚Äìborder);
display: none;
margin-top: 32px;
}

.detail-panel.show {
display: block;
animation: slideUp 0.4s ease-out;
}

@keyframes slideUp {
from { opacity: 0; transform: translateY(30px); }
to { opacity: 1; transform: translateY(0); }
}

.detail-header {
margin-bottom: 32px;
padding-bottom: 24px;
border-bottom: 2px solid var(‚Äìborder);
}

.detail-title {
font-size: 28px;
font-weight: 700;
color: var(‚Äìtext-primary);
margin-bottom: 16px;
}

.detail-meta {
display: flex;
gap: 12px;
flex-wrap: wrap;
}

.section {
margin-bottom: 40px;
}

.section-header {
font-size: 20px;
font-weight: 600;
color: var(‚Äìtext-primary);
margin-bottom: 20px;
display: flex;
align-items: center;
gap: 12px;
}

.section-icon {
width: 40px;
height: 40px;
background: linear-gradient(135deg, var(‚Äìprimary), #34d399);
border-radius: 10px;
display: flex;
align-items: center;
justify-content: center;
color: white;
font-size: 18px;
box-shadow: 0 4px 12px rgba(5, 150, 105, 0.2);
}

/* Timeline */
.timeline {
position: relative;
padding-left: 40px;
margin-top: 24px;
}

.timeline::before {
content: ‚Äò‚Äô;
position: absolute;
left: 12px;
top: 0;
bottom: 0;
width: 3px;
background: linear-gradient(180deg, var(‚Äìprimary), #34d399);
}

.timeline-item {
position: relative;
margin-bottom: 24px;
padding: 20px;
background: var(‚Äìbg-main);
border-radius: 12px;
border-left: 4px solid var(‚Äìprimary);
}

.timeline-item::before {
content: ‚Äò‚Äô;
position: absolute;
left: -48px;
top: 24px;
width: 20px;
height: 20px;
background: var(‚Äìprimary);
border-radius: 50%;
border: 4px solid var(‚Äìbg-card);
box-shadow: 0 0 0 2px var(‚Äìprimary);
}

.timeline-step {
font-weight: 600;
color: var(‚Äìtext-primary);
margin-bottom: 8px;
font-size: 15px;
}

.timeline-note {
color: var(‚Äìtext-secondary);
font-size: 14px;
margin-bottom: 8px;
line-height: 1.6;
}

.timeline-date {
color: var(‚Äìtext-secondary);
font-size: 12px;
font-weight: 500;
}

/* Messages */
.message-list {
display: flex;
flex-direction: column;
gap: 16px;
margin-top: 24px;
}

.message-item {
padding: 20px;
background: var(‚Äìbg-main);
border-radius: 12px;
border-left: 4px solid var(‚Äìsecondary);
}

.message-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 12px;
}

.message-role {
font-weight: 600;
color: var(‚Äìsecondary);
font-size: 14px;
display: flex;
align-items: center;
gap: 6px;
}

.message-date {
color: var(‚Äìtext-secondary);
font-size: 12px;
}

.message-body {
color: var(‚Äìtext-primary);
line-height: 1.6;
}

/* Documents */
.doc-list {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
gap: 16px;
margin-top: 24px;
}

.doc-item {
padding: 20px;
background: var(‚Äìbg-main);
border: 2px solid var(‚Äìborder);
border-radius: 12px;
transition: all 0.3s;
}

.doc-item:hover {
border-color: var(‚Äìprimary);
box-shadow: var(‚Äìshadow);
transform: translateY(-4px);
}

.doc-label {
font-weight: 600;
color: var(‚Äìtext-primary);
margin-bottom: 8px;
font-size: 15px;
}

.doc-date {
color: var(‚Äìtext-secondary);
font-size: 12px;
margin-bottom: 16px;
}

/* Products */
.product-item {
padding: 24px;
background: var(‚Äìbg-main);
border: 2px solid var(‚Äìborder);
border-radius: 16px;
margin-bottom: 20px;
}

.product-header {
display: flex;
justify-content: space-between;
align-items: start;
margin-bottom: 20px;
gap: 16px;
}

.product-names h3 {
font-size: 18px;
color: var(‚Äìtext-primary);
margin-bottom: 6px;
}

.product-common {
color: var(‚Äìtext-secondary);
font-size: 14px;
}

.blocker-badge {
background: #ef4444;
color: white;
padding: 8px 16px;
border-radius: 10px;
font-size: 13px;
font-weight: 600;
display: flex;
align-items: center;
gap: 6px;
}

.product-fields {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 16px;
margin-bottom: 16px;
}

.field-item {
padding: 12px;
background: white;
border-radius: 8px;
border: 1px solid var(‚Äìborder);
}

.field-label {
font-size: 11px;
color: var(‚Äìtext-secondary);
margin-bottom: 4px;
font-weight: 600;
text-transform: uppercase;
letter-spacing: 0.5px;
}

.field-value {
font-size: 14px;
color: var(‚Äìtext-primary);
font-weight: 500;
}

.empty-state {
text-align: center;
padding: 80px 20px;
color: var(‚Äìtext-secondary);
}

.empty-icon {
font-size: 72px;
margin-bottom: 20px;
opacity: 0.3;
}

.empty-text {
font-size: 16px;
line-height: 1.6;
}

@media (max-width: 768px) {
.header-content {
flex-direction: column;
align-items: flex-start;
}

.projects-grid {
grid-template-columns: 1fr;
}

.product-fields {
grid-template-columns: 1fr;
}

.login-card {
padding: 32px 24px;
}
}
</style>

</head>
<body>

<!-- Login Page -->

<div class="page active" id="loginPage">
  <div class="login-page">
    <div class="login-container">
      <div class="login-card">
        <div class="login-header">
          <div class="login-icon">üåæ</div>
          <h1 class="login-title">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h1>
          <p class="login-subtitle">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</p>
        </div>

```
    <div class="input-group">
      <label class="input-label">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
      <div class="input-wrapper">
        <span class="input-icon">üë§</span>
        <input type="email" id="email" class="form-input" placeholder="your@email.com" autocomplete="email">
      </div>
    </div>
    
    <div class="input-group">
      <label class="input-label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
      <div class="input-wrapper">
        <span class="input-icon">üîí</span>
        <input type="password" id="password" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
      </div>
    </div>
    
    <button class="btn btn-primary" id="btnSignIn">
      <span>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span>
      <span>‚Üí</span>
    </button>
    
    <div id="authMsg"></div>
  </div>
</div>
```

  </div>
</div>

<!-- Main App Page -->

<div class="page" id="appPage">
  <div class="app-page">
    <!-- Header -->
    <div class="header">
      <div class="header-content">
        <div class="header-left">
          <div class="header-logo">üåæ</div>
          <h1 class="header-title">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Å‡∏ï‡πå</h1>
        </div>
        <div class="header-right">
          <span class="badge" id="userEmail">üë§ ‚Äî</span>
          <button class="btn btn-outline" id="btnSignOut">
            <span>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
            <span>‚Üí</span>
          </button>
        </div>
      </div>
    </div>

```
<!-- Main Content -->
<div class="container">
  <!-- Welcome Card -->
  <div class="welcome-card">
    <h2>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</h2>
    <p id="companyName">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
  </div>

  <!-- Projects Section -->
  <div class="projects-section">
    <div class="section-title">
      <span>üìã</span>
      <span>‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Å‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</span>
    </div>
    <div class="projects-grid" id="projectsList"></div>
  </div>

  <!-- Project Detail -->
  <div class="detail-panel" id="detailPanel">
    <div class="detail-header">
      <div class="detail-title" id="detailTitle">‚Äî</div>
      <div class="detail-meta" id="detailMeta"></div>
    </div>

    <!-- Timeline -->
    <div class="section">
      <div class="section-header">
        <div class="section-icon">‚è±Ô∏è</div>
        <span>‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
      </div>
      <div class="timeline" id="timeline"></div>
    </div>

    <!-- Messages -->
    <div class="section">
      <div class="section-header">
        <div class="section-icon">üí¨</div>
        <span>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô</span>
      </div>
      <div class="message-list" id="messages"></div>
    </div>

    <!-- Documents -->
    <div class="section">
      <div class="section-header">
        <div class="section-icon">üìé</div>
        <span>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</span>
      </div>
      <div class="doc-list" id="docs"></div>
    </div>

    <!-- Products -->
    <div class="section">
      <div class="section-header">
        <div class="section-icon">üì¶</div>
        <span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå/‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</span>
      </div>
      
      <!-- Search Bar for Products -->
      <div style="position: relative; margin-bottom: 20px;">
        <span style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); font-size: 18px; color: var(--text-secondary);">üîç</span>
        <input 
          type="text" 
          id="productSearch" 
          placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤, ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç, ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô, ‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö..." 
          style="width: 100%; padding: 12px 16px 12px 48px; border: 2px solid var(--border); border-radius: 12px; font-size: 15px; font-family: 'Prompt', sans-serif; transition: all 0.3s;"
          onfocus="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 0 0 3px rgba(5, 150, 105, 0.1)';"
          onblur="this.style.borderColor='var(--border)'; this.style.boxShadow='none';"
        >
      </div>
      
      <div id="items"></div>
    </div>
  </div>
</div>
```

  </div>
</div>

<script>
const SUPABASE_URL = 'https://jlrogimfjmtwdqiuyejj.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impscm9naW1mam10d2RxaXV5ZWpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NDIyODUsImV4cCI6MjA3NTUxODI4NX0.OvX7qgcIF5aCcLebUEUR_6D2KTUP2pALCjRtHWJ5qZg';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUser = null;
let currentCompanyId = null;
let selectedProject = null;

const el = id => document.getElementById(id);
const esc = s => (s ?? '').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');

function showPage(pageId) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  el(pageId).classList.add('active');
}

function showMsg(id, text, type = '') {
  const n = el(id);
  if (!n) return;
  if (!text) {
    n.innerHTML = '';
    return;
  }
  n.innerHTML = `<div class="alert alert-${type || 'info'}">${text}</div>`;
}

function getStatusText(status) {
  const map = {
    waiting_docs: '‡∏£‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£',
    precheck: '‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô',
    submitted: '‡∏¢‡∏∑‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
    pending_result: '‡∏£‡∏≠‡∏ú‡∏•',
    done: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
    rejected: '‡∏ñ‡∏π‡∏Å‡∏ï‡∏µ‡∏Å‡∏•‡∏±‡∏ö'
  };
  return map[status] || status;
}

/* Auth */
async function signIn() {
  const email = el('email').value.trim();
  const password = el('password').value;
  
  if (!email || !password) {
    showMsg('authMsg', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', 'error');
    return;
  }
  
  const btn = el('btnSignIn');
  btn.disabled = true;
  btn.innerHTML = '<span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...</span>';
  
  try {
    const { error } = await sb.auth.signInWithPassword({ email, password });
    if (error) throw error;
    showMsg('authMsg', '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
  } catch (e) {
    showMsg('authMsg', '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.message, 'error');
    btn.disabled = false;
    btn.innerHTML = '<span>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span><span>‚Üí</span>';
  }
}

async function signOut() {
  await sb.auth.signOut();
  location.reload();
}

async function checkAuth() {
  const { data: s } = await sb.auth.getSession();
  if (!s.session) {
    showPage('loginPage');
    return false;
  }
  
  currentUser = s.session.user;
  
  // Get membership and company_id
  const { data, error } = await sb
    .from('memberships')
    .select('role, company_id')
    .eq('user_id', currentUser.id)
    .limit(1);
    
  if (error || !data || data.length === 0) {
    showMsg('authMsg', '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á', 'error');
    showPage('loginPage');
    return false;
  }
  
  const membership = data[0];
  
  // Only allow client role
  if (membership.role !== 'client') {
    showMsg('authMsg', '‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', 'error');
    showPage('loginPage');
    return false;
  }
  
  currentCompanyId = membership.company_id;
  
  if (!currentCompanyId) {
    showMsg('authMsg', '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Å‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó', 'error');
    showPage('loginPage');
    return false;
  }
  
  el('userEmail').textContent = 'üë§ ' + currentUser.email;
  
  // Load company name
  const { data: company } = await sb
    .from('companies')
    .select('name')
    .eq('id', currentCompanyId)
    .single();
    
  if (company) {
    el('companyName').textContent = company.name;
  }
  
  showPage('appPage');
  await loadProjects();
  
  return true;
}

/* Projects */
async function loadProjects() {
  if (!currentCompanyId) return;
  
  const { data, error } = await sb
    .from('projects')
    .select('id, title, status, due_date')
    .eq('company_id', currentCompanyId)
    .order('created_at', { ascending: false });
    
  if (error) {
    console.error('Load projects error:', error);
    return;
  }
  
  const list = el('projectsList');
  
  if (!data || data.length === 0) {
    list.innerHTML = `
      <div class="empty-state" style="grid-column: 1/-1;">
        <div class="empty-icon">üìã</div>
        <div class="empty-text">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Å‡∏ï‡πå</div>
      </div>
    `;
    return;
  }
  
  list.innerHTML = data.map(project => `
    <div class="project-card" onclick="selectProject(${JSON.stringify(project).replace(/"/g, '&quot;')})">
      <div class="project-header">
        <div class="project-title">${esc(project.title)}</div>
        <div class="status-badge status-${project.status}">
          ${getStatusText(project.status)}
        </div>
      </div>
      <div class="project-meta">
        <div class="meta-item">
          üìÖ ${project.due_date || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
        </div>
      </div>
    </div>
  `).join('');
}

async function selectProject(project) {
  selectedProject = project;
  
  document.querySelectorAll('.project-card').forEach(c => c.classList.remove('selected'));
  event.target.closest('.project-card')?.classList.add('selected');
  
  el('detailPanel').classList.add('show');
  el('detailPanel').scrollIntoView({ behavior: 'smooth', block: 'start' });
  
  el('detailTitle').textContent = project.title;
  el('detailMeta').innerHTML = `
    <span class="status-badge status-${project.status}">${getStatusText(project.status)}</span>
    <span class="badge" style="background: #e0e7ff; color: #4338ca;">üìÖ ${project.due_date || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>
  `;
  
  await loadTimeline();
  await loadMessages();
  await loadDocs();
  await loadItems();
}

/* Timeline */
async function loadTimeline() {
  if (!selectedProject) return;
  
  const { data, error } = await sb.from('timeline')
    .select('*')
    .eq('project_id', selectedProject.id)
    .order('created_at', { ascending: false });
    
  if (error) return;
  
  const container = el('timeline');
  
  if (!data || data.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-text">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå</div></div>';
    return;
  }
  
  container.innerHTML = data.map(t => `
    <div class="timeline-item">
      <div class="timeline-step">${esc(t.step)}</div>
      ${t.note ? `<div class="timeline-note">${esc(t.note)}</div>` : ''}
      <div class="timeline-date">${new Date(t.created_at).toLocaleString('th-TH')}</div>
    </div>
  `).join('');
}

/* Messages */
async function loadMessages() {
  if (!selectedProject) return;
  
  const { data, error } = await sb.from('messages')
    .select('*')
    .eq('project_id', selectedProject.id)
    .order('created_at', { ascending: false });
    
  if (error) return;
  
  const container = el('messages');
  
  if (!data || data.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-text">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</div></div>';
    return;
  }
  
  container.innerHTML = data.map(m => `
    <div class="message-item">
      <div class="message-header">
        <div class="message-role">üë§ ‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô</div>
        <div class="message-date">${new Date(m.created_at).toLocaleString('th-TH')}</div>
      </div>
      <div class="message-body">${esc(m.body)}</div>
    </div>
  `).join('');
}

/* Documents */
async function loadDocs() {
  if (!selectedProject) return;
  
  const { data, error } = await sb.from('documents')
    .select('*')
    .eq('project_id', selectedProject.id)
    .order('created_at', { ascending: false });
    
  if (error) return;
  
  const container = el('docs');
  
  if (!data || data.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-text">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</div></div>';
    return;
  }
  
  const html = await Promise.all(data.map(async doc => {
    const { data: signed } = await sb.storage
      .from('docs')
      .createSignedUrl(doc.file_path, 600);
      
    return `
      <div class="doc-item">
        <div class="doc-label">üìÑ ${esc(doc.label)}</div>
        <div class="doc-date">${new Date(doc.created_at).toLocaleString('th-TH')}</div>
        <a href="${signed?.signedUrl || '#'}" target="_blank" class="btn btn-outline" style="width: 100%;">
          ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå ‚Üí
        </a>
      </div>
    `;
  }));
  
  container.innerHTML = html.join('');
}

/* Products */
async function loadItems() {
  if (!selectedProject) return;
  
  const searchTerm = (el('productSearch')?.value || '').trim().toLowerCase();
  
  const { data, error } = await sb.from('product_items')
    .select('*')
    .eq('project_id', selectedProject.id)
    .order('created_at', { ascending: false });
    
  if (error) return;
  
  // Filter by search term
  let filteredData = data || [];
  if (searchTerm) {
    filteredData = filteredData.filter(item => {
      const searchableText = [
        item.trade_name,
        item.common_name,
        item.reg_no,
        item.receipt_no
      ].filter(Boolean).join(' ').toLowerCase();
      return searchableText.includes(searchTerm);
    });
  }
  
  const container = el('items');
  
  if (filteredData.length === 0) {
    if (searchTerm) {
      container.innerHTML = '<div class="empty-state"><div class="empty-text">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div></div>';
    } else {
      container.innerHTML = '<div class="empty-state"><div class="empty-text">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå</div></div>';
    }
    return;
  }
  
  container.innerHTML = filteredData.map(item => `
    <div class="product-item">
      <div class="product-header">
        <div class="product-names">
          <h3>${esc(item.trade_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤')}</h3>
          <div class="product-common">${esc(item.common_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç')}</div>
        </div>
        ${item.blocker ? '<div class="blocker-badge">‚ö†Ô∏è ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤</div>' : ''}
      </div>
      
      <div class="product-fields">
        <div class="field-item">
          <div class="field-label">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</div>
          <div class="field-value">${esc(item.reg_no || '-')}</div>
        </div>
        <div class="field-item">
          <div class="field-label">‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ö</div>
          <div class="field-value">${esc(item.receipt_no || '-')}</div>
        </div>
        <div class="field-item">
          <div class="field-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
          <div class="field-value">
            <span class="status-badge status-${item.status_step}">
              ${getStatusText(item.status_step)}
            </span>
          </div>
        </div>
        <div class="field-item">
          <div class="field-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡πà‡∏ô</div>
          <div class="field-value">${item.submitted_at || '-'}</div>
        </div>
      </div>
      
      ${item.client_note ? `
        <div class="field-item" style="margin-top: 12px;">
          <div class="field-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</div>
          <div class="field-value">${esc(item.client_note)}</div>
        </div>
      ` : ''}
      
      ${item.blocker && item.blocker_note ? `
        <div class="field-item" style="margin-top: 12px; background: #fee; border-color: #fcc;">
          <div class="field-label" style="color: #ef4444;">‚ö†Ô∏è ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤</div>
          <div class="field-value" style="color: #ef4444;">${esc(item.blocker_note)}</div>
        </div>
      ` : ''}
    </div>
  `).join('');
}

/* Init */
document.addEventListener('DOMContentLoaded', async () => {
  el('btnSignIn').onclick = signIn;
  el('btnSignOut').onclick = signOut;
  
  el('email').onkeypress = e => e.key === 'Enter' && signIn();
  el('password').onkeypress = e => e.key === 'Enter' && signIn();
  
  // Product search with debounce
  let searchTimeout;
  const productSearchInput = el('productSearch');
  if (productSearchInput) {
    productSearchInput.oninput = () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        if (selectedProject) loadItems();
      }, 300);
    };
  }
  
  sb.auth.onAuthStateChange(async () => {
    await checkAuth();
  });
  
  await checkAuth();
  
  // Realtime
  sb.channel('realtime-client')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'projects' }, () => {
      if (currentCompanyId) loadProjects();
    })
    .on('postgres_changes', { event: '*', schema: 'public', table: 'timeline' }, () => {
      if (selectedProject) loadTimeline();
    })
    .on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, () => {
      if (selectedProject) loadMessages();
    })
    .on('postgres_changes', { event: '*', schema: 'public', table: 'documents' }, () => {
      if (selectedProject) loadDocs();
    })
    .on('postgres_changes', { event: '*', schema: 'public', table: 'product_items' }, () => {
      if (selectedProject) loadItems();
    })
    .subscribe();
});
</script>

</body>
</html>
