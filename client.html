<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ลูกค้า — ติดตามงานขึ้นทะเบียน</title>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{ --bg:#0f172a; --card:#0e1628; --ink:#e5e7eb; --muted:#94a3b8; --border:#1f2937; --accent:#22d3ee;}
  *{box-sizing:border-box}
  body{margin:0; background:linear-gradient(180deg,#0b1224,#0f172a); color:var(--ink); font-family:'Prompt',system-ui;}
  .wrap{max-width:1100px; margin:24px auto; padding:16px}
  .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; margin-bottom:16px}
  .row{display:flex; gap:8px; align-items:center; margin:8px 0; flex-wrap:wrap}
  .muted{color:var(--muted); font-size:12px}
  .btn{border-radius:10px; border:1px solid var(--border); padding:10px 14px; background:#0b2b2f; color:#aaf3ff; font-weight:700; cursor:pointer}
  .btn:hover{filter:brightness(1.1)}
  .tabs{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0}
  .tab{padding:6px 10px; border:1px solid var(--border); border-radius:999px; cursor:pointer; background:#071a29}
  .tab.active{outline:2px solid var(--accent)}
  .item{padding:10px; border:1px solid var(--border); border-radius:10px; background:#0b1224}
  a{color:#86e1f0}
  input,select{border-radius:10px; border:1px solid var(--border); background:#071326; color:var(--ink); padding:10px 12px}
</style>
</head>
<body>
<div class="wrap">
  <h2>พอร์ทัลลูกค้า — ติดตามงานขึ้นทะเบียน</h2>

  <!-- การ์ดล็อกอินบัญชี (อีเมล/รหัสผ่าน) -->
  <div id="authCard" class="card">
    <div class="row"><strong>เข้าสู่ระบบลูกค้า</strong> <span class="muted">กรุณาล็อกอินด้วยอีเมลและรหัสผ่านของคุณ</span></div>
    <div class="row">
      <input id="email" placeholder="email@example.com">
      <input id="password" type="password" placeholder="รหัสผ่าน">
      <button class="btn" id="btnSignIn">เข้าสู่ระบบ</button>
      <button class="btn" id="btnSignOut" style="display:none">ออกจากระบบ</button>
    </div>
    <div class="muted" id="authMsg"></div>
  </div>

  <!-- Gate: Company Login (หลังจากล็อกอินบัญชีแล้ว) -->
  <div id="loginCard" class="card" style="display:none">
    <div class="row"><strong>ยืนยันบริษัทของคุณ</strong> <span class="muted">กรอกรหัสบริษัท + Login ID ที่ได้รับจากผู้ให้บริการ</span></div>
    <div class="row">
      <input id="companyCode" placeholder="รหัสบริษัท (เช่น RGD001)">
      <input id="loginId" placeholder="Login ID (เช่น client01)">
      <button class="btn" id="btnConfirmCompany">ยืนยัน</button>
      <button class="btn" id="btnLine1">ติดต่อเจ้าหน้าที่ผ่าน LINE</button>
    </div>
    <div class="muted">* ต้องล็อกอินบัญชีของคุณก่อน หากยังไม่ได้ล็อกอิน โปรดเข้าสู่ระบบด้านบน</div>
    <div class="muted" id="loginMsg"></div>
  </div>

  <!-- Main (เฉพาะลูกค้าที่ผ่านการยืนยันบริษัท) -->
  <div id="main" style="display:none">
    <div class="card" style="display:flex; justify-content:space-between; align-items:center">
      <div class="row" style="margin:0">
        <input id="kw" placeholder="ค้นหา: ชื่อการค้า/ชื่อสามัญ/ทะเบียน/เลขรับ/หมายเหตุ" style="min-width:320px">
        <select id="status">
          <option value="">ทุกสถานะ</option>
          <option value="waiting_docs">รอเอกสาร</option>
          <option value="precheck">ตรวจเบื้องต้น</option>
          <option value="submitted">ยื่นแล้ว</option>
          <option value="pending_result">รอผล</option>
          <option value="done">เสร็จสิ้น</option>
          <option value="rejected">ถูกตีกลับ</option>
        </select>
        <label class="tab"><input type="checkbox" id="onlyBlocker" style="accent-color:#22d3ee"> เฉพาะที่มีปัญหา</label>
      </div>
      <div class="row" style="margin:0">
        <button class="btn" id="btnLine2">ติดต่อเจ้าหน้าที่ผ่าน LINE</button>
      </div>
    </div>

    <div class="card">
      <div class="tabs" id="tabs">
        <div class="tab active" data-step="">ทั้งหมด</div>
        <div class="tab" data-step="waiting_docs">รอเอกสาร</div>
        <div class="tab" data-step="precheck">ตรวจเบื้องต้น</div>
        <div class="tab" data-step="submitted">ยื่นแล้ว</div>
        <div class="tab" data-step="pending_result">รอผล</div>
        <div class="tab" data-step="done">เสร็จสิ้น</div>
        <div class="tab" data-step="rejected">ถูกตีกลับ</div>
        <div class="tab" data-step="__blocker__">เฉพาะมีปัญหา</div>
      </div>
      <div id="items"></div>
    </div>

    <div class="card">
      <h3 id="companyHeader"></h3>
      <div class="muted">ดูความคืบหน้ารวมของทุกโปรเจ็กต์ด้านบน • หากมีข้อสงสัยกด “ติดต่อเจ้าหน้าที่ผ่าน LINE”</div>
    </div>
  </div>
</div>

<script>
/* ===== Config (ฝังค่าโปรเจ็กต์จริง) ===== */
const SUPABASE_URL = 'https://jlrogimfjmtwdqiuyejj.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impscm9naW1mam10d2RxaXV5ZWpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NDIyODUsImV4cCI6MjA3NTUxODI4NX0.OvX7qgcIF5aCcLebUEUR_6D2KTUP2pALCjRtHWJ5qZg';
const LINE_CONTACT_URL = 'https://line.me/R/ti/p/@991cyisb';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== State ===== */
let company = { code: null, id: null, role: null };
let activeTab = '';

/* ===== Helpers ===== */
const el = id => document.getElementById(id);
const tabsEl = () => document.getElementById('tabs');

function openLine(prefMsg){
  const msg = prefMsg ? `?msg=${encodeURIComponent(prefMsg)}` : '';
  window.open(LINE_CONTACT_URL + msg, '_blank');
}
function msg(id, text){ const n = document.getElementById(id); if(n) n.textContent = text || ''; }

/* ===== Auth (ลูกค้าต้องล็อกอินบัญชี) ===== */
async function signIn(){
  const email = el('email').value.trim();
  const password = el('password').value;
  if(!email || !password){ return msg('authMsg','กรอกอีเมลและรหัสผ่าน'); }
  const { error } = await sb.auth.signInWithPassword({ email, password });
  if(error){ return msg('authMsg','เข้าสู่ระบบไม่สำเร็จ: ' + error.message); }
  // afterAuth() จะถูกเรียกโดย onAuthStateChange
}

async function signOut(){
  await sb.auth.signOut();
  localStorage.removeItem('companyCode');
  localStorage.removeItem('loginId');
  location.reload();
}

async function afterAuth(){
  const { data: s } = await sb.auth.getSession();
  const signedIn = !!s.session;
  el('btnSignIn').style.display = signedIn ? 'none' : '';
  el('btnSignOut').style.display = signedIn ? '' : 'none';
  el('loginCard').style.display = signedIn ? 'block' : 'none';
  msg('authMsg', signedIn ? 'เข้าสู่ระบบแล้ว' : '');
}

/* ===== Company Gate (ตรวจสิทธิ์บริษัท) ===== */
async function confirmCompany(){
  const code = el('companyCode').value.trim();
  const loginId = el('loginId').value.trim();
  if(!code || !loginId){
    msg('loginMsg','กรุณากรอกรหัสบริษัทและ Login ID'); return;
  }
  const { data: s } = await sb.auth.getSession();
  if(!s.session){ msg('loginMsg','ยังไม่ได้ล็อกอินบัญชีลูกค้า'); return; }

  // RPC: check_company_access ต้องมีจากสคีมาที่ให้ไว้
  const { data, error } = await sb.rpc('check_company_access', { p_company_code: code, p_login_id: loginId });
  if(error || !data || data.length === 0){
    msg('loginMsg','ยืนยันบริษัท/สิทธิ์ไม่ผ่าน — โปรดตรวจสอบรหัสบริษัทหรือ Login ID'); return;
  }
  company.id = data[0].company_id;
  company.code = code;
  company.role = data[0].role;

  localStorage.setItem('companyCode', code);
  localStorage.setItem('loginId', loginId);

  el('companyHeader').textContent = `บริษัท: ${code}`;
  el('main').style.display = 'block';
  await refreshList();
  subscribeRealtime();
}

/* ===== ดึง/แสดงรายการสินค้า (Read-Only) ===== */
async function refreshList(){
  const { data, error } = await sb
    .from('v_product_items_search')
    .select('trade_name,common_name,reg_no,receipt_no,status_step,blocker,blocker_note,admin_note,client_note,updated_at')
    .eq('company_id', company.id)
    .order('updated_at', { ascending: false });
  if(error){ el('items').innerHTML = `<div class="muted">โหลดข้อมูลไม่สำเร็จ</div>`; return; }
  renderItems(data || []);
}

function renderItems(rows){
  const kw = (el('kw').value || '').toLowerCase().trim();
  const statusSel = el('status').value || '';
  const onlyBlocker = el('onlyBlocker').checked;
  const tabStep = activeTab;

  let list = rows;

  if(kw){
    list = list.filter(x=>{
      const s = [
        x.trade_name, x.common_name, x.reg_no, x.receipt_no,
        x.admin_note, x.client_note, x.blocker_note
      ].filter(Boolean).join(' ').toLowerCase();
      return s.includes(kw);
    });
  }
  if(statusSel) list = list.filter(x => (x.status_step||'') === statusSel);
  if(tabStep){
    if(tabStep === '__blocker__'){ list = list.filter(x => x.blocker); }
    else list = list.filter(x => (x.status_step||'') === tabStep);
  }
  if(onlyBlocker) list = list.filter(x => x.blocker);

  el('items').innerHTML = list.map(x=>`
    <div class="item">
      <div><strong>${x.trade_name || '-'}</strong> <span class="muted">(${x.common_name || '-'})</span></div>
      <div class="muted">ทะเบียน: ${x.reg_no || '-'} • เลขรับ: ${x.receipt_no || '-'}</div>
      <div class="muted">สถานะ: ${x.status_step || '-'}</div>
      <div class="muted">ปัญหา: ${x.blocker ? 'มี' : 'ไม่มี'} ${x.blocker && x.blocker_note ? '— '+x.blocker_note : ''}</div>
      <div class="muted">หมายเหตุทีม: ${x.admin_note || '-'}</div>
      <div class="muted">หมายเหตุลูกค้า: ${x.client_note || '-'}</div>
      <div class="muted">อัปเดต: ${new Date(x.updated_at).toLocaleString()}</div>
    </div>
  `).join('') || `<div class="muted">ไม่พบรายการ</div>`;
}

function subscribeRealtime(){
  sb.channel('rt-client-plus')
    .on('postgres_changes',{event:'*',schema:'public',table:'product_items'}, refreshList)
    .on('postgres_changes',{event:'*',schema:'public',table:'timeline'}, refreshList)
    .on('postgres_changes',{event:'*',schema:'public',table:'messages'}, refreshList)
    .on('postgres_changes',{event:'*',schema:'public',table:'documents'}, refreshList)
    .subscribe();
}

/* ===== Init & Events ===== */
document.addEventListener('DOMContentLoaded', async ()=>{
  // Supabase Auth state
  sb.auth.onAuthStateChange(afterAuth);
  await afterAuth();

  // ปุ่มล็อกอิน/ออก
  el('btnSignIn').onclick = signIn;
  el('btnSignOut').onclick = signOut;

  // ยืนยันบริษัท
  el('btnConfirmCompany').onclick = confirmCompany;

  // LINE
  el('btnLine1').onclick = ()=>openLine('[ลูกค้า] ขอความช่วยเหลือเรื่องการยืนยันบริษัท');
  el('btnLine2').onclick = ()=>openLine('[ลูกค้า] สอบถามสถานะรายการขึ้นทะเบียน');

  // ฟิลเตอร์/ค้นหา
  ['kw','status','onlyBlocker'].forEach(id=>{
    const n = el(id); if(n) n.oninput = ()=>refreshList();
  });

  // Tabs
  document.querySelectorAll('#tabs .tab').forEach(t=>{
    t.onclick = ()=>{
      document.querySelectorAll('#tabs .tab').forEach(tt=>tt.classList.remove('active'));
      t.classList.add('active');
      activeTab = t.dataset.step || '';
      refreshList();
    };
  });

  // เติมค่าจาก query string / localStorage (ถ้ามี)
  const u = new URL(location.href);
  const qCompany = u.searchParams.get('company');
  const qLogin = u.searchParams.get('login');
  if(qCompany) el('companyCode').value = qCompany;
  if(qLogin) el('loginId').value = qLogin;

  if(!qCompany){ const saved = localStorage.getItem('companyCode'); if(saved) el('companyCode').value = saved; }
  if(!qLogin){ const saved = localStorage.getItem('loginId'); if(saved) el('loginId').value = saved; }
});
</script>
</body>
</html>
