<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ลูกค้า — ติดตามงานขึ้นทะเบียน (View Only)</title>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<style>
  :root{
    --bg:#0f172a; --card:#0e1628; --ink:#e5e7eb; --muted:#94a3b8; --border:#1f2937; --accent:#22d3ee;
    --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b1224,#0f172a);color:var(--ink);font-family:'Prompt',system-ui}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  header{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .brand{display:flex;gap:10px;align-items:center}
  img.logo{width:44px;height:44px;border-radius:10px;box-shadow:0 0 16px rgba(255,255,255,.12)}
  h1{font-size:20px;margin:0}
  .muted{color:var(--muted);font-size:13px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 10px 26px rgba(0,0,0,.24)}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  input,select{background:#071326;color:var(--ink);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#072027;border:1px solid #10343a;font-size:12px}
  .list{display:flex;flex-direction:column;gap:10px}
  .item{background:#0b1220;border:1px solid var(--border);border-radius:14px;padding:12px}
  .item h3{margin:0 0 6px 0;font-size:16px}
  .section{margin-top:10px}
  .section h4{margin:0 0 6px 0;font-size:14px}
  .pill{display:inline-block;border-radius:999px;padding:4px 10px;font-size:12px;font-weight:700}
  .st-wait{background:rgba(148,163,184,.16);color:#cbd5e1}
  .st-pre{background:rgba(37,99,235,.14);color:#93c5fd}
  .st-sub{background:rgba(34,211,238,.14);color:#67e8f9}
  .st-pend{background:rgba(245,158,11,.14);color:#fbbf24}
  .st-done{background:rgba(16,185,129,.14);color:#34d399}
  .st-rej{background:rgba(239,68,68,.14);color:#f87171}
  .kbar{display:flex;gap:8px;flex-wrap:wrap}
  table{width:100%;border-collapse:collapse;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  th,td{border-bottom:1px solid var(--border);padding:10px;font-size:13px;text-align:left}
  th{background:#0a192f;color:#cbd5e1}
  .hint{font-size:12px;color:var(--muted)}
  .link{color:#7dd3fc}
  .center{display:flex;align-items:center;justify-content:center}
  .empty{padding:16px;border:1px dashed #2b3c52;border-radius:12px;text-align:center;color:#9fb3c8}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;background:#0b2237;border:1px solid #14344c;border-radius:999px;font-size:12px}
  /* accordion */
  .acc{border:1px solid var(--border);border-radius:14px;overflow:hidden;background:#0b1220}
  .acc-h{display:flex;align-items:center;justify-content:space-between;padding:12px;cursor:pointer}
  .acc-h:hover{background:#0c1930}
  .acc-b{display:none;padding:12px;border-top:1px solid var(--border);background:#0b1220}
  .acc.open .acc-b{display:block}
  /* splash */
  #splash{position:fixed;inset:0;background:#0b1224;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999}
  #splash img{width:100px;border-radius:12px;animation:spin 4s linear infinite}
  #splash h2{margin-top:10px;font-size:16px;color:#dbeafe}
  @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
</style>
</head>
<body>
<!-- Splash -->
<div id="splash">
  <img src="https://i.ibb.co/J1KDprF/image.jpg" alt="logo">
  <h2>กำลังตรวจสอบสิทธิ์ลูกค้า…</h2>
</div>

<div class="wrap" id="app" style="display:none">
  <header>
    <div class="brand">
      <img class="logo" src="https://i.ibb.co/J1KDprF/image.jpg" alt="logo">
      <div>
        <h1>พอร์ทัลลูกค้า — ระบบติดตามงานขึ้นทะเบียน</h1>
        <div class="muted" id="who"></div>
      </div>
    </div>
    <div class="row">
      <a class="chip" href="index.html">← กลับหน้าแรก</a>
      <a class="chip" target="_blank" href="https://line.me/R/ti/p/@991cyisb">LINE OA: @991cyisb</a>
    </div>
  </header>

  <!-- แถบค้นหา/ตัวกรองระดับบริษัท -->
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:flex-end">
      <div>
        <div class="muted">บริษัท:</div>
        <div class="row" id="companyBadges"></div>
      </div>
      <div class="row">
        <input id="q" placeholder="ค้นหาโปรเจ็กต์/บริษัท/โค้ด…">
        <button id="btnRefresh">รีเฟรช</button>
      </div>
    </div>
  </div>

  <!-- รายการโปรเจ็กต์ -->
  <div class="section">
    <h4>โปรเจ็กต์ของบริษัทคุณ</h4>
    <div id="projects" class="list"></div>
    <div id="projMsg" class="hint" style="margin-top:8px"></div>
  </div>
</div>

<script>
/* ===== Config: ใช้ของคุณที่ให้มา ===== */
const SUPABASE_URL = 'https://jlrogimfjmtwdqiuyejj.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impscm9naW1mam10d2RxaXV5ZWpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NDIyODUsImV4cCI6MjA3NTUxODI4NX0.OvX7qgcIF5aCcLebUEUR_6D2KTUP2pALCjRtHWJ5qZg';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== Utils ===== */
const qs = new URLSearchParams(location.search);
const COMPANY_CODE = (qs.get('company')||'').trim();
const LOGIN_ID = (qs.get('login')||'').trim();
const el = id => document.getElementById(id);
const fmtDate = d => { if(!d) return '-'; const x=new Date(d); if(isNaN(x)) return '-'; return x.toLocaleDateString('th-TH'); };
function statusChip(s){
  const map = {
    waiting_docs: ['st-wait','รอเอกสาร'],
    precheck: ['st-pre','ตรวจเบื้องต้น'],
    submitted: ['st-sub','ยื่นแล้ว'],
    pending_result: ['st-pend','รอผล'],
    done: ['st-done','เสร็จสิ้น'],
    rejected: ['st-rej','ถูกตีกลับ']
  };
  const [cls,txt] = map[s] || ['st-wait', s||'-'];
  return `<span class="pill ${cls}">${txt}</span>`;
}
function isDriveLink(url){ return /https?:\/\/(drive\.google\.com|docs\.google\.com)/i.test(url||''); }
function toDrivePreview(url){
  if(!url) return '';
  const m = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
  if(m) return `https://drive.google.com/file/d/${m[1]}/preview`;
  if(url.includes('docs.google.com')) return url.replace(/\/edit.*$/,'/pub?embedded=true');
  return url;
}
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])); }

/* ===== State ===== */
let company = null;         // {id,name,code}
let client = null;          // {id,login_id,display_name}
let projects = [];          // list of projects

/* ===== Boot: verify client ===== */
(async function boot(){
  if(!COMPANY_CODE || !LOGIN_ID){
    alert('ลิงก์ไม่ครบ: ต้องมี ?company=รหัสบริษัท&login=ไอดีลูกค้า');
    return;
  }
  try{
    // หา company
    const { data:co, error:ce } = await sb.from('companies').select('id,name,code').eq('code', COMPANY_CODE).maybeSingle();
    if(ce) throw ce;
    if(!co){ alert('ไม่พบบริษัทตามรหัสที่ให้'); return; }
    company = co;

    // ตรวจ client (ต้องมีในตาราง clients และ is_active = true)
    const { data:cl, error:cle } = await sb
      .from('clients')
      .select('id,login_id,display_name,is_active')
      .eq('company_id', company.id)
      .eq('login_id', LOGIN_ID)
      .eq('is_active', true)
      .maybeSingle();
    if(cle) throw cle;
    if(!cl){ alert('รหัสลูกค้าไม่ถูกต้อง หรือถูกปิดใช้งาน'); return; }
    client = cl;

    // UI header
    el('who').textContent = `บริษัท: ${company.name} (รหัส ${company.code}) • ผู้เข้าใช้: ${client.display_name||client.login_id} — โหมดอ่านอย่างเดียว`;

    // load projects
    await loadProjects();

    // splash → app
    document.getElementById('splash').style.display='none';
    document.getElementById('app').style.display='block';

    // search
    el('btnRefresh').onclick = loadProjects;
    el('q').oninput = filterProjectsPaint;
  }catch(e){
    console.error(e);
    alert('เกิดข้อผิดพลาดในการเข้าถึงข้อมูลลูกค้า');
  }
})();

/* ===== Load projects of this company ===== */
async function loadProjects(){
  const box = el('projects'); box.innerHTML = '';
  el('projMsg').textContent = 'กำลังโหลด…';
  try{
    // โปรเจ็กต์ทั้งหมดของบริษัทนี้
    let { data:rows, error } = await sb
      .from('projects')
      .select('id,title,status,due_date,companies:company_id(name,code)')
      .eq('company_id', company.id)
      .order('created_at',{ascending:false});
    if(error) throw error;
    projects = rows || [];

    // paint
    paintCompanyBadges();
    filterProjectsPaint();
    el('projMsg').textContent = `รวม ${projects.length} โปรเจ็กต์`;
  }catch(e){
    console.error(e);
    el('projMsg').textContent = 'โหลดโปรเจ็กต์ไม่ได้';
  }
}

function paintCompanyBadges(){
  const area = document.getElementById('companyBadges');
  area.innerHTML = `
    <span class="badge">บริษัท: ${escapeHtml(company?.name||'-')}</span>
    <span class="badge">รหัส: ${escapeHtml(company?.code||'-')}</span>
    <span class="badge">ลูกค้า: ${escapeHtml(client?.display_name||client?.login_id||'-')}</span>
  `;
}

/* ===== Paint projects with accordion ===== */
function filterProjectsPaint(){
  const q = (el('q').value||'').toLowerCase();
  const box = el('projects'); box.innerHTML = '';

  const list = (projects||[]).filter(p=>{
    if(!q) return true;
    const s = `${p.title||''} ${p.status||''} ${p.companies?.name||''} ${p.companies?.code||''}`.toLowerCase();
    return s.includes(q);
  });

  if(!list.length){
    box.innerHTML = `<div class="empty">— ไม่พบโปรเจ็กต์ที่ตรงกับคำค้น —</div>`;
    return;
  }

  for(const p of list){
    const acc = document.createElement('div'); acc.className='acc';
    acc.innerHTML = `
      <div class="acc-h">
        <div class="row">
          <h3>${escapeHtml(p.title||'-')}</h3>
          <span class="pill">${statusChip(p.status)}</span>
          <span class="badge">กำหนดส่ง: ${fmtDate(p.due_date)||'-'}</span>
        </div>
        <div class="muted">คลิกเพื่อดูรายละเอียด</div>
      </div>
      <div class="acc-b">
        <div class="section">
          <h4>รายการผลิตภัณฑ์/ทะเบียน</h4>
          <div class="kbar">
            <input id="s-${p.id}-kw" placeholder="ค้นหา: ชื่อการค้า/ชื่อสามัญ/ทะเบียน/เลขรับ" style="flex:1;min-width:260px">
            <select id="s-${p.id}-st">
              <option value="">ทุกสถานะ</option>
              <option value="waiting_docs">รอเอกสาร</option>
              <option value="precheck">ตรวจเบื้องต้น</option>
              <option value="submitted">ยื่นแล้ว</option>
              <option value="pending_result">รอผล</option>
              <option value="done">เสร็จสิ้น</option>
              <option value="rejected">ถูกตีกลับ</option>
            </select>
            <label class="badge"><input type="checkbox" id="s-${p.id}-blk"> เฉพาะที่มีปัญหา</label>
            <span class="muted" id="s-${p.id}-msg"></span>
          </div>
          <div id="tbl-${p.id}" class="section"></div>
        </div>

        <div class="section">
          <h4>ไทม์ไลน์ขั้นตอน</h4>
          <div id="tl-${p.id}" class="list"></div>
        </div>

        <div class="section">
          <h4>เอกสารแนบ</h4>
          <div id="dc-${p.id}" class="list"></div>
        </div>

        <div class="section">
          <h4>ข้อความจากทีมงาน</h4>
          <div id="mg-${p.id}" class="list"></div>
        </div>
      </div>
    `;
    // toggle
    acc.querySelector('.acc-h').onclick = async ()=>{
      acc.classList.toggle('open');
      if(acc.classList.contains('open')){
        await Promise.all([
          loadItems(p.id),
          loadTimeline(p.id),
          loadDocs(p.id),
          loadMessages(p.id)
        ]);
        // bind filters for items
        const kw = el(`s-${p.id}-kw`);
        const st = el(`s-${p.id}-st`);
        const bk = el(`s-${p.id}-blk`);
        [kw,st,bk].forEach(n=>n && (n.oninput = ()=>loadItems(p.id)));
      }
    };
    box.appendChild(acc);
  }
}

/* ===== Items (read-only list with filters) ===== */
async function loadItems(projectId){
  const kw = (el(`s-${projectId}-kw`)?.value||'').toLowerCase();
  const st = (el(`s-${projectId}-st`)?.value||'');
  const bk = !!(el(`s-${projectId}-blk`)?.checked);
  const msg = el(`s-${projectId}-msg`);
  const tblBox = el(`tbl-${projectId}`);
  msg.textContent = 'กำลังโหลด…'; tblBox.innerHTML = '';

  try{
    const { data, error } = await sb
      .from('product_items')
      .select('id,trade_name,common_name,reg_no,receipt_no,status_step,admin_note,client_note,blocker,blocker_note,updated_at')
      .eq('project_id', projectId)
      .order('created_at',{ascending:false});
    if(error) throw error;
    let rows = data || [];

    if(kw){
      rows = rows.filter(x=>{
        const s = [x.trade_name,x.common_name,x.reg_no,x.receipt_no,x.admin_note,x.client_note,x.blocker_note].filter(Boolean).join(' ').toLowerCase();
        return s.includes(kw);
      });
    }
    if(st) rows = rows.filter(x => (x.status_step||'') === st);
    if(bk) rows = rows.filter(x => x.blocker);

    if(!rows.length){
      tblBox.innerHTML = `<div class="empty">— ไม่พบรายการ —</div>`;
      msg.textContent = '';
      return;
    }

    const html = `
      <table>
        <thead>
          <tr>
            <th>ชื่อการค้า</th>
            <th>ชื่อสามัญ</th>
            <th>ทะเบียน</th>
            <th>เลขรับ</th>
            <th>สถานะ</th>
            <th>ปัญหา</th>
            <th>หมายเหตุ (ลูกค้าเห็น)</th>
            <th>อัปเดตล่าสุด</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(x=>`
            <tr>
              <td>${escapeHtml(x.trade_name||'-')}</td>
              <td>${escapeHtml(x.common_name||'-')}</td>
              <td>${escapeHtml(x.reg_no||'-')}</td>
              <td>${escapeHtml(x.receipt_no||'-')}</td>
              <td>${statusChip(x.status_step||'')}</td>
              <td>${x.blocker ? ('มี' + (x.blocker_note? ' — '+escapeHtml(x.blocker_note):'')) : 'ไม่มี'}</td>
              <td>${escapeHtml(x.client_note||'-')}</td>
              <td>${fmtDate(x.updated_at)||'-'}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
    tblBox.innerHTML = html;
    msg.textContent = `รวม ${rows.length} รายการ`;
  }catch(e){
    console.error(e);
    msg.textContent = 'โหลดรายการไม่ได้';
  }
}

/* ===== Timeline (read-only) ===== */
async function loadTimeline(projectId){
  const box = el(`tl-${projectId}`); box.innerHTML = '';
  try{
    const { data, error } = await sb
      .from('timeline')
      .select('id,step,note,created_at')
      .eq('project_id', projectId)
      .order('created_at',{ascending:false});
    if(error) throw error;
    if(!data || !data.length){
      box.innerHTML = `<div class="empty">— ยังไม่มีไทม์ไลน์ —</div>`;
      return;
    }
    for(const r of data){
      const div = document.createElement('div'); div.className='item';
      div.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <div><strong>${escapeHtml(r.step||'-')}</strong></div>
          <div class="muted">${fmtDate(r.created_at)}</div>
        </div>
        ${r.note? `<div class="muted">${escapeHtml(r.note)}</div>`:''}
      `;
      box.appendChild(div);
    }
  }catch(e){
    console.error(e);
    box.innerHTML = `<div class="empty">โหลดไทม์ไลน์ไม่ได้</div>`;
  }
}

/* ===== Docs (read-only with Drive/PDF preview) ===== */
async function loadDocs(projectId){
  const box = el(`dc-${projectId}`); box.innerHTML = '';
  try{
    const { data, error } = await sb
      .from('documents')
      .select('id,label,file_path,created_at,public_url,url_override')
      .eq('project_id', projectId)
      .order('created_at',{ascending:false});
    if(error) throw error;

    if(!data || !data.length){
      box.innerHTML = `<div class="empty">— ยังไม่มีเอกสารแนบ —</div>`;
      return;
    }

    for(const d of data){
      const card = document.createElement('div'); card.className='item';
      let preview = '';
      // รองรับ 2 กรณี: อัปโหลดใน Supabase Storage หรือใส่ลิงก์ Drive/PDF (url_override)
      if(d.url_override && isDriveLink(d.url_override)){
        const prev = toDrivePreview(d.url_override);
        preview = `
          <div class="muted">ไฟล์: <a class="link" href="${escapeHtml(d.url_override)}" target="_blank">เปิดในแท็บใหม่</a></div>
          <iframe src="${prev}" style="width:100%;height:360px;border:1px solid var(--border);border-radius:10px;background:#000" allow="autoplay"></iframe>
        `;
      }else if(d.url_override){
        // ลิงก์ภายนอกทั่วไป (PDF/เว็บไซต์)
        preview = `<div class="muted">ไฟล์: <a class="link" href="${escapeHtml(d.url_override)}" target="_blank">${escapeHtml(d.url_override)}</a></div>`;
      }else if(d.file_path){
        // ไฟล์ใน Storage (สร้างลิงก์ชั่วคราว)
        try{
          const { data: signed } = await sb.storage.from('docs').createSignedUrl(d.file_path, 60*10);
          const link = signed?.signedUrl || '#';
          const isPdf = /\.pdf($|\?)/i.test(d.file_path);
          preview = `
            <div class="muted">ไฟล์: <a class="link" href="${link}" target="_blank">เปิดไฟล์</a></div>
            ${ isPdf ? `<iframe src="${link}" style="width:100%;height:360px;border:1px solid var(--border);border-radius:10px;background:#000"></iframe>` : '' }
          `;
        }catch(e){
          preview = `<div class="muted">ไฟล์: เปิดลิงก์ไม่ได้</div>`;
        }
      }

      card.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <div><strong>${escapeHtml(d.label||'ไฟล์แนบ')}</strong></div>
          <div class="muted">${fmtDate(d.created_at)}</div>
        </div>
        ${preview}
      `;
      box.appendChild(card);
    }
  }catch(e){
    console.error(e);
    box.innerHTML = `<div class="empty">โหลดเอกสารไม่ได้</div>`;
  }
}

/* ===== Messages (read-only) ===== */
async function loadMessages(projectId){
  const box = el(`mg-${projectId}`); box.innerHTML = '';
  try{
    const { data, error } = await sb
      .from('messages')
      .select('id,body,by_role,created_at')
      .eq('project_id', projectId)
      .order('created_at',{ascending:false});
    if(error) throw error;
    if(!data || !data.length){
      box.innerHTML = `<div class="empty">— ยังไม่มีข้อความ —</div>`;
      return;
    }
    for(const m of data){
      const card = document.createElement('div'); card.className='item';
      const role = m.by_role || 'staff';
      card.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <div><strong>[${escapeHtml(role)}]</strong> ${escapeHtml(m.body||'')}</div>
          <div class="muted">${fmtDate(m.created_at)}</div>
        </div>
      `;
      box.appendChild(card);
    }
  }catch(e){
    console.error(e);
    box.innerHTML = `<div class="empty">โหลดข้อความไม่ได้</div>`;
  }
}
</script>
</body>
</html>
